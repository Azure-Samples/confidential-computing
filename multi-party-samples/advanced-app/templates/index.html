<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidential ACI - Attestation Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #0078d4;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #0078d4;
        }
        
        /* Collapsible section styling */
        details.section > summary {
            list-style: none;
            cursor: pointer;
            padding-bottom: 10px;
            border-bottom: 3px solid #0078d4;
            margin-bottom: 20px;
        }
        
        details.section > summary::-webkit-details-marker {
            display: none;
        }
        
        details.section > summary::before {
            content: '‚ñ∂ ';
            color: #0078d4;
            transition: transform 0.2s;
        }
        
        details.section[open] > summary::before {
            content: '‚ñº ';
        }
        
        details.section > summary h2 {
            display: inline;
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid #0078d4;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .info-card h3 {
            color: #495057;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .info-card p {
            color: #0078d4;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .attestation-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 25px 0;
        }
        
        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1em;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background: #005a9e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,120,212,0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .status-success {
            background: #28a745;
            color: white;
        }
        
        .status-error {
            background: #dc3545;
            color: white;
        }
        
        .status-info {
            background: #17a2b8;
            color: white;
        }
        
        .status-warning {
            background: #ffc107;
            color: #333;
        }
        
        .output-box {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.6;
            margin: 20px 0;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .output-box pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .features-list {
            list-style: none;
            padding: 0;
        }
        
        .features-list li {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-left: 4px solid #6c757d;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .features-list li.verified {
            border-left-color: #28a745;
        }
        
        .features-list li.unverified {
            border-left-color: #dc3545;
        }
        
        .features-list li.pending {
            border-left-color: #6c757d;
        }
        
        .features-list li .status-icon {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .features-list li.verified .status-icon {
            color: #28a745;
        }
        
        .features-list li.unverified .status-icon {
            color: #dc3545;
        }
        
        .features-list li.pending .status-icon {
            color: #6c757d;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            color: #666;
            font-size: 0.9em;
        }
        
        .footer a {
            color: #0078d4;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .page-timer {
            position: fixed;
            top: 10px;
            right: 15px;
            background: rgba(0, 120, 212, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-family: monospace;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .page-timer .timer-icon {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <!-- Page Timer -->
    <div class="page-timer">
        <span class="timer-icon">‚è±Ô∏è</span>
        <span id="pageTimer">00:00</span>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üîí Confidential Azure Container Instances</h1>
            <p>Remote Attestation Demo with AMD SEV-SNP</p>
        </div>
        
        <div class="content">
            <details class="section" open>
                <summary style="cursor: pointer;"><h2 style="display: inline;">üõ°Ô∏è Security Features</h2></summary>
                <p id="securityStatus" style="margin-bottom: 15px; font-style: italic; color: #6c757d; margin-top: 15px;">
                    Click "Request Attestation Token" to verify security features...
                </p>
                <ul class="features-list" id="featuresList">
                    <li class="pending" data-feature="tee"><span class="status-icon">‚óã</span> Hardware-based Trusted Execution Environment (TEE)</li>
                    <li class="pending" data-feature="memory"><span class="status-icon">‚óã</span> Memory encryption with AMD SEV-SNP technology</li>
                    <li class="pending" data-feature="confidentiality"><span class="status-icon">‚óã</span> Data confidentiality and integrity protection</li>
                    <li class="pending" data-feature="policy"><span class="status-icon">‚óã</span> Code integrity verification through security policies</li>
                    <li class="pending" data-feature="attestation"><span class="status-icon">‚óã</span> Remote attestation with cryptographic proof</li>
                    <li class="pending" data-feature="protection"><span class="status-icon">‚óã</span> Protection against cloud provider and hardware attacks</li>
                </ul>
            </details>
            
            <details class="section">
                <summary style="cursor: pointer;"><h2 style="display: inline;">üîç Remote Attestation</h2></summary>
                <div class="attestation-box" style="margin-top: 15px;">
                    <p><strong>Remote attestation</strong> allows you to cryptographically verify that your workload is running in a genuine confidential computing environment with the expected security configuration.</p>
                    
                    <div class="button-group">
                        <button id="attestBtn" onclick="requestAttestation()">
                            Request Attestation Token
                        </button>
                        <button id="rawBtn" onclick="requestRawAttestation()">
                            Get Raw Attestation Report
                        </button>
                    </div>
                    
                    <div id="attestResult"></div>
                </div>
            </details>
            
            <details class="section">
                <summary style="cursor: pointer;"><h2 style="display: inline;">üîë Secure Key Release</h2></summary>
                <div class="attestation-box" style="margin-top: 15px;">
                    <p><strong>Secure Key Release (SKR)</strong> allows Azure Key Vault to release cryptographic keys only to verified confidential computing environments. The key is released only if the container proves it's running in a genuine AMD SEV-SNP TEE with the correct security policy.</p>
                    
                    <div id="skrConfigInfo" style="margin: 20px 0; padding: 20px; background: #e7f3ff; border-radius: 8px; border: 2px solid #0078d4;">
                        <p style="color: #004085;"><em>Loading SKR configuration...</em></p>
                    </div>
                    
                    <div class="button-group">
                        <button id="skrBtn" onclick="testSecureKeyRelease()">
                            üîê Test Secure Key Release
                        </button>
                    </div>
                    
                    <div id="skrResult"></div>
                </div>
            </details>
            
            <!-- Cross-Company Key Access Attempt Section -->
            <details class="section" id="crossCompanySection" style="display: none;">
                <summary style="cursor: pointer;"><h2 style="display: inline;">&#128683; Attempt to Use Key from Other Company</h2></summary>
                <div class="attestation-box" style="border-left-color: #dc3545; margin-top: 15px;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8d7da; border-radius: 8px; border: 2px solid #dc3545;">
                        <p style="color: #721c24;"><strong>Cross-Company Access Test:</strong> This demonstrates that even though both Contoso and Fabrikam are running in confidential containers with TEE protection, each company can ONLY access their own cryptographic keys.</p>
                    </div>
                    
                    <div id="crossCompanyInfo" style="margin-bottom: 20px; padding: 15px; background: #e2e3e5; border-radius: 8px;">
                        <p style="color: #495057;"><em>Loading company information...</em></p>
                    </div>
                    
                    <div class="button-group">
                        <button id="attemptOtherKeyBtn" onclick="attemptOtherCompanyKey()" style="background: #dc3545;">
                            &#128683; Attempt to Access Other Company's Key
                        </button>
                    </div>
                    
                    <div id="crossCompanyResult" style="margin-top: 20px;"></div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">&#128161; Why This Matters</h4>
                        <ul style="color: #856404; margin-left: 20px;">
                            <li><strong>Managed Identity Isolation</strong> - Each company has its own Azure Managed Identity</li>
                            <li><strong>Key Vault Access Policies</strong> - Each Key Vault only grants access to its company's identity</li>
                            <li><strong>TEE is Necessary but Not Sufficient</strong> - Being in a TEE proves code integrity, but doesn't grant access to other companies' secrets</li>
                            <li><strong>Multi-Party Security</strong> - Companies can share infrastructure while maintaining cryptographic isolation</li>
                        </ul>
                    </div>
                </div>
            </details>
            
            <!-- Partner Demographic Analysis Section (Woodgrove Bank Only) -->
            <details class="section" id="partnerAnalysisSection" style="display: none;">
                <summary style="cursor: pointer;"><h2 style="display: inline;">&#128202; Partner Demographic Analysis</h2></summary>
                <div class="attestation-box" style="border-left-color: #1a472a; margin-top: 15px;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #d4edda; border-radius: 8px; border: 2px solid #1a472a;">
                        <p style="color: #155724;"><strong>&#127970; Woodgrove Bank Partner Analysis System</strong></p>
                        <p style="color: #155724; margin-top: 8px;">As a trusted analytics partner, Woodgrove Bank has been granted secure key release access to both Contoso and Fabrikam's Key Vaults. This allows aggregate demographic analysis while maintaining cryptographic isolation.</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div id="contosoKeyStatus" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span id="contosoStatusIcon" style="font-size: 20px;">‚è≥</span>
                                <strong style="color: #495057;">Contoso Key</strong>
                            </div>
                            <p id="contosoStatusText" style="color: #6c757d; font-size: 12px;">Not started</p>
                        </div>
                        <div id="fabrikamKeyStatus" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span id="fabrikamStatusIcon" style="font-size: 20px;">‚è≥</span>
                                <strong style="color: #495057;">Fabrikam Key</strong>
                            </div>
                            <p id="fabrikamStatusText" style="color: #6c757d; font-size: 12px;">Not started</p>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button id="startPartnerAnalysisBtn" onclick="startPartnerAnalysis()" style="background: #1a472a;">
                            &#128202; Start Partner Demographic Analysis
                        </button>
                    </div>
                    
                    <!-- Progress Bar Section -->
                    <div id="progressSection" style="display: none; margin-top: 20px;">
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; border: 2px solid #1a472a;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span id="progressStatus" style="font-weight: bold; color: #1a472a;">Initializing...</span>
                                <span id="progressPercent" style="font-weight: bold; color: #1a472a;">0%</span>
                            </div>
                            <div style="background: #dee2e6; border-radius: 10px; height: 24px; overflow: hidden;">
                                <div id="progressBar" style="background: linear-gradient(90deg, #1a472a 0%, #28a745 100%); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px; color: #6c757d;">
                                <span id="progressDecrypted">0 / 0 records</span>
                                <span id="progressTime">Elapsed: 0s | Remaining: --</span>
                            </div>
                            <div id="progressPartner" style="margin-top: 8px; font-size: 12px; color: #495057;"></div>
                        </div>
                    </div>
                    
                    <div id="partnerAnalysisResult" style="margin-top: 20px;"></div>
                    
                    <!-- Demographics Summary -->
                    <div id="demographicsSummary" style="display: none; margin-top: 25px;">
                        <h4 style="color: #1a472a; margin-bottom: 15px;">&#128202; Aggregate Demographics Summary</h4>
                        
                        <!-- Staff Count Cards -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center; color: white;">
                                <div style="font-size: 32px; font-weight: bold;" id="statContosoRecords">0</div>
                                <div style="font-size: 12px; opacity: 0.9;">Contoso Staff</div>
                            </div>
                            <div style="padding: 20px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 8px; text-align: center; color: white;">
                                <div style="font-size: 32px; font-weight: bold;" id="statFabrikamRecords">0</div>
                                <div style="font-size: 12px; opacity: 0.9;">Fabrikam Staff</div>
                            </div>
                            <div style="padding: 20px; background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%); border-radius: 8px; text-align: center; color: white;">
                                <div style="font-size: 32px; font-weight: bold;" id="statTotalRecords">0</div>
                                <div style="font-size: 12px; opacity: 0.9;">Total Combined</div>
                            </div>
                        </div>
                        
                        <!-- Average Salaries -->
                        <h5 style="color: #1a472a; margin: 20px 0 10px 0;">üí∞ Average Salaries</h5>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="padding: 15px; background: #e8eaf6; border-radius: 8px; text-align: center; border: 2px solid #667eea;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="avgSalaryContoso">$0</div>
                                <div style="font-size: 12px; color: #495057;">Contoso Avg</div>
                            </div>
                            <div style="padding: 15px; background: #e0f2f1; border-radius: 8px; text-align: center; border: 2px solid #11998e;">
                                <div style="font-size: 24px; font-weight: bold; color: #11998e;" id="avgSalaryFabrikam">$0</div>
                                <div style="font-size: 12px; color: #495057;">Fabrikam Avg</div>
                            </div>
                            <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; text-align: center; border: 2px solid #1a472a;">
                                <div style="font-size: 24px; font-weight: bold; color: #1a472a;" id="avgSalaryCombined">$0</div>
                                <div style="font-size: 12px; color: #495057;">Combined Avg</div>
                            </div>
                        </div>
                        
                        <!-- Generation Breakdown -->
                        <h5 style="color: #1a472a; margin: 20px 0 10px 0;">üë• Workforce by Generation</h5>
                        <div id="generationBreakdown" style="margin-bottom: 20px;"></div>
                        
                        <!-- Eye Colors -->
                        <h5 style="color: #1a472a; margin: 20px 0 10px 0;">üëÅÔ∏è Eye Color Distribution</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="padding: 15px; background: #d4edda; border-radius: 8px; border: 2px solid #28a745;">
                                <div style="font-size: 14px; color: #155724; margin-bottom: 5px;">Most Common</div>
                                <div style="font-size: 20px; font-weight: bold; color: #155724;" id="eyeColorMost">-</div>
                            </div>
                            <div style="padding: 15px; background: #f8d7da; border-radius: 8px; border: 2px solid #dc3545;">
                                <div style="font-size: 14px; color: #721c24; margin-bottom: 5px;">Least Common</div>
                                <div style="font-size: 20px; font-weight: bold; color: #721c24;" id="eyeColorLeast">-</div>
                            </div>
                        </div>
                        
                        <!-- Favorite Colors -->
                        <h5 style="color: #1a472a; margin: 20px 0 10px 0;">üé® Top 3 Favorite Colors</h5>
                        <div id="favoriteColors" style="display: flex; gap: 15px; margin-bottom: 20px;"></div>
                        
                        <!-- Top 10 Countries with Cities -->
                        <h5 style="color: #1a472a; margin: 20px 0 10px 0;">üåç Top 10 Countries (with Top 3 Cities)</h5>
                        <div id="countriesTable" style="margin-bottom: 20px;"></div>
                    </div>
                </div>
            </details>
            
            <!-- Protect data in a multi-party environment Section -->
            <details class="section" id="companyDataSection" style="display: none;">
                <summary style="cursor: pointer;"><h2 style="display: inline;">&#128101; Protect Data in a Multi-Party Environment</h2></summary>
                <div class="attestation-box" style="border-left-color: #198754; margin-top: 15px;">
                    <div id="companyDataHeader" style="margin-bottom: 20px; padding: 15px; background: #d1e7dd; border-radius: 8px; border: 2px solid #198754;">
                        <p style="color: #0f5132;"><strong id="companyName">Company: </strong> - Data entered here will be encrypted with your company's SKR key and stored securely.</p>
                    </div>
                    
                    <!-- Add Record Box -->
                    <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #198754;">
                        <h4 style="color: #198754; margin-bottom: 15px;">&#10133; Add Record</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label for="dataFieldName" style="display: block; font-weight: bold; margin-bottom: 5px; color: #495057;">Name:</label>
                            <input type="text" id="dataFieldName" placeholder="Enter name..." style="width: 100%; padding: 12px; border: 2px solid #ced4da; border-radius: 6px; font-size: 1em;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label for="dataFieldPhone" style="display: block; font-weight: bold; margin-bottom: 5px; color: #495057;">Phone Number:</label>
                            <input type="text" id="dataFieldPhone" placeholder="Enter phone number (e.g., +1 555-123-4567)..." style="width: 100%; padding: 12px; border: 2px solid #ced4da; border-radius: 6px; font-size: 1em;">
                        </div>
                        
                        <div class="button-group">
                            <button id="saveDataBtn" onclick="saveCompanyData()" style="background: #198754;">
                                &#128190; Encrypt &amp; Save Record
                            </button>
                        </div>
                        
                        <div id="saveDataResult" style="margin-top: 15px;"></div>
                    </div>
                    
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button id="populateDbBtn" onclick="populateFromCsv()" style="background: #6610f2;">
                            &#128203; Populate DB from CSV
                        </button>
                        <button id="listDataBtn" onclick="listCompanyData()" style="background: #0dcaf0; color: #000;">
                            &#128196; List Saved Records
                        </button>
                    </div>
                    
                    <div id="populateResult" style="margin-bottom: 20px;"></div>
                    
                    <div id="companyDataViewer" style="margin-top: 20px; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #495057; margin: 0;">&#128202; Saved Company Records</h4>
                            <button id="decryptToggleBtn" 
                                    onclick="toggleDecryptView()"
                                    style="background: #6f42c1; padding: 8px 16px; font-size: 0.85em;">
                                &#128275; Press to Decrypt
                            </button>
                        </div>
                        <div id="companyDataContent" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #dee2e6;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #d1e7dd; border-radius: 8px; border-left: 4px solid #198754;">
                        <h4 style="color: #0f5132; margin-bottom: 10px;">&#128274; Security Features</h4>
                        <ul style="color: #0f5132; margin-left: 20px;">
                            <li><strong>SKR Protected</strong> - Data is encrypted with company-specific key from Azure Key Vault HSM</li>
                            <li><strong>Company Isolation</strong> - Each company can only encrypt with their own key</li>
                            <li><strong>Attestation Required</strong> - Key was only released after TEE attestation passed</li>
                            <li><strong>RSA-OAEP-SHA256</strong> - Strong encryption algorithm with HSM-backed keys</li>
                        </ul>
                    </div>
                </div>
            </details>
            
            <details class="section">
                <summary style="cursor: pointer; display: flex; align-items: center; gap: 10px;">
                    <h2 style="margin: 0;">&#128274; Encrypt Data Using <span id="encryptionCompanyName">Company</span> Key</h2>
                </summary>
                <div class="attestation-box">
                    <p><strong>Live Encryption Demo:</strong> After successfully releasing a key, you can encrypt text in real-time using the released RSA key. The encryption uses RSA-OAEP with SHA-256 padding.</p>
                    
                    <div id="encryptionStatus" style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <p style="color: #856404;"><em>‚ö†Ô∏è Key not released yet. Click "Test Secure Key Release" above first.</em></p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            <label for="plaintextInput" style="display: block; font-weight: bold; margin-bottom: 10px; color: #495057;">
                                üìù Plaintext Input
                            </label>
                            <textarea 
                                id="plaintextInput" 
                                placeholder="Type your secret message here..."
                                style="width: 100%; height: 150px; padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; resize: vertical;"
                                oninput="encryptRealtime()"
                                disabled
                            ></textarea>
                            <p style="margin-top: 5px; font-size: 0.85em; color: #6c757d;">
                                <span id="plaintextLength">0</span> characters | Max: <span id="maxPlaintextLength">--</span> bytes
                            </p>
                        </div>
                        <div>
                            <label for="ciphertextOutput" style="display: block; font-weight: bold; margin-bottom: 10px; color: #495057;">
                                üîê Encrypted Output (Base64)
                            </label>
                            <textarea 
                                id="ciphertextOutput" 
                                placeholder="Encrypted ciphertext will appear here..."
                                style="width: 100%; height: 150px; padding: 15px; border: 2px solid #28a745; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; background: #f8f9fa; resize: vertical;"
                                readonly
                            ></textarea>
                            <p style="margin-top: 5px; font-size: 0.85em; color: #6c757d;">
                                <span id="ciphertextLength">0</span> bytes encrypted | Algorithm: RSA-OAEP-SHA256
                            </p>
                        </div>
                    </div>
                    
                    <div id="encryptionInfo" style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #0078d4; display: none;">
                        <h4 style="color: #004085; margin-bottom: 10px;">‚ÑπÔ∏è How it works</h4>
                        <ul style="color: #004085; margin-left: 20px;">
                            <li>The released key (RSA public key) is stored in server memory</li>
                            <li>Your plaintext is encrypted using RSA-OAEP with SHA-256</li>
                            <li>Only the holder of the private key (Azure Key Vault HSM) can decrypt</li>
                            <li>The private key never leaves the HSM - even after release</li>
                        </ul>
                    </div>
                </div>
            </details>
            
            <details class="section" id="blobStorageSection">
                <summary style="cursor: pointer;"><h2 style="display: inline;">&#128193; External Blob Storage Access</h2></summary>
                <div class="attestation-box" style="border-left-color: #fd7e14; margin-top: 15px;">
                    
                    <!-- Snooper Attacker Explainer - Only shown for non-confidential containers -->
                    <div id="snooperExplainer" style="display: none; margin-bottom: 20px; padding: 20px; background: #2d2d2d; border-radius: 8px; border: 3px solid #dc3545;">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">&#128373; Attacker's View - What a Snooper Sees</h4>
                        <p style="color: #f8f8f2; margin-bottom: 15px;">This container represents a <strong style="color: #ff6b6b;">potential attacker</strong> or untrusted party who has gained access to the storage system. They can:</p>
                        <ul style="color: #f8f8f2; margin-left: 20px; margin-bottom: 15px;">
                            <li style="margin-bottom: 8px;">&#10004; <strong>List all files</strong> in the storage container</li>
                            <li style="margin-bottom: 8px;">&#10004; <strong>Download any file</strong> including consolidated-records.json</li>
                            <li style="margin-bottom: 8px;">&#10004; <strong>See all encrypted data</strong> from Contoso and Fabrikam</li>
                            <li style="margin-bottom: 8px;">&#10060; <strong style="color: #ff6b6b;">CANNOT decrypt any data</strong> - No access to SKR keys!</li>
                        </ul>
                        <div style="padding: 15px; background: #198754; border-radius: 6px;">
                            <p style="color: white; margin: 0;"><strong>&#128274; Key Insight:</strong> You can use a <em>completely untrusted storage location</em> to host sensitive data, as long as encryption keys are only released to verified TEE environments. Even if attackers compromise the storage, they see only meaningless ciphertext.</p>
                        </div>
                    </div>
                    
                    <!-- Auto-refresh indicator for snooper -->
                    <div id="autoRefreshIndicator" style="display: none; margin-bottom: 15px; padding: 10px 15px; background: #343a40; border-radius: 6px; color: #f8f9fa;">
                        <span style="color: #28a745;">&#9679;</span> Auto-refreshing every <span id="refreshInterval">5</span> seconds | Last update: <span id="lastRefreshTime">--:--:--</span>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #0078d4;">
                        <h4 style="color: #0078d4; margin-bottom: 10px;">&#128737; Azure Confidential Computing Data Protection Model</h4>
                        <p style="color: #495057; margin-bottom: 10px;">This section demonstrates how <strong>Azure Confidential Computing (ACC)</strong> can protect sensitive data even when stored in shared environments you don't fully control - or even completely public data stores.</p>
                        <p style="color: #495057; margin-bottom: 10px;"><strong>The key insight:</strong> Anyone can access the encrypted data below, but <em>decryption keys are only ever released when your application proves (via hardware attestation) that it is running inside a Trusted Execution Environment (TEE)</em>.</p>
                        <ul style="color: #495057; margin-left: 20px; margin-bottom: 10px;">
                            <li><strong>Keys never leave the TEE</strong> - Secure Key Release ensures cryptographic keys are only available to attested, confidential workloads</li>
                            <li><strong>Sealed/Blackbox Deployments</strong> - Confidential computing enforcement policies block interactive access to your application containers</li>
                            <li><strong>Zero-trust data sharing</strong> - Store encrypted data anywhere; only your verified confidential containers can decrypt it</li>
                            <li><strong>Multi-party collaboration</strong> - Multiple parties can share a data store while each protects their own secrets</li>
                        </ul>
                        <p style="color: #0078d4; font-size: 0.9em;"><strong>&#128272; Result:</strong> Even if attackers gain access to your storage, cloud infrastructure, or container orchestration - they cannot decrypt your data without compromising the hardware TEE itself.</p>
                    </div>
                    
                    <div id="storageConfigInfo" style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border: 2px solid #fd7e14;">
                        <p style="color: #856404;"><em>Loading storage configuration...</em></p>
                    </div>
                    
                    <div class="button-group">
                        <button id="listBlobsBtn" onclick="listBlobStorage()" style="background: #fd7e14;">
                            üìÇ List Blob Contents
                        </button>
                        <button id="refreshBlobsBtn" onclick="listBlobStorage()" style="background: #6c757d;" disabled>
                            üîÑ Refresh
                        </button>
                    </div>
                    
                    <div id="blobListResult" style="margin-top: 20px;"></div>
                    
                    <!-- Snooper's view of consolidated records -->
                    <div id="snooperRecordsView" style="display: none; margin-top: 20px;">
                        <h4 id="snooperRecordsHeader" style="color: #dc3545; margin-bottom: 15px;">&#128373; Intercepted Encrypted Records (<span id="snooperBlobName">consolidated-records.json</span>)</h4>
                        <div id="snooperRecordsTable" style="background: #1e1e1e; padding: 20px; border-radius: 8px; border: 2px solid #dc3545;">
                            <p style="color: #f8f8f2;"><em>Loading intercepted data...</em></p>
                        </div>
                    </div>
                    
                    <div id="blobContentViewer" style="margin-top: 20px; display: none;">
                        <h4 style="color: #495057; margin-bottom: 10px;">üìÑ Blob Content Viewer</h4>
                        <div style="background: #2d2d2d; color: #f8f8f2; padding: 20px; border-radius: 6px; max-height: 300px; overflow: auto;">
                            <pre id="blobContentPre" style="margin: 0; white-space: pre-wrap; word-wrap: break-word;"></pre>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <h4 style="color: #721c24; margin-bottom: 10px;">&#9888;&#65039; Demo: What Happens Without TEE Protection</h4>
                        <ul style="color: #721c24; margin-left: 20px;">
                            <li><strong>Encrypted data is visible to all</strong> - The snooper container CAN list and download encrypted blobs</li>
                            <li><strong>But decryption is impossible</strong> - Without passing attestation, the snooper CANNOT obtain the SKR keys needed to decrypt</li>
                            <li><strong>Confidential enforcement policy</strong> - Even if attackers deploy their own container, it won't match the signed policy hash</li>
                            <li><strong>Compare the containers</strong> - Contoso/Fabrikam can decrypt their data; the snooper sees only ciphertext</li>
                        </ul>
                    </div>
                </div>
            </details>
            
            <details class="section">
                <summary style="cursor: pointer;"><h2 style="display: inline;">&#128202; Deployment Information</h2></summary>
                <div id="deploymentInfo" style="margin-top: 15px;">
                    <p>Loading deployment information...</p>
                </div>
            </details>
            
            <details class="section">
                <summary style="cursor: pointer;"><h2 style="display: inline;">üì¶ Container Image Information</h2></summary>
                <div id="containerInfo" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #6c757d; margin-top: 15px;">
                    <p><em>Loading container information...</em></p>
                </div>
            </details>
        </div>
        
        <div class="footer">
            <p><strong>Powered by Azure Container Instances Confidential Computing</strong></p>
            <p>Learn more: <a href="https://learn.microsoft.com/azure/container-instances/container-instances-confidential-overview" target="_blank">Confidential containers on ACI documentation</a></p>
            <p>Sample based on: <a href="https://github.com/Azure-Samples/confidential-container-samples" target="_blank">Azure Confidential Container Samples</a></p>
        </div>
    </div>
    
    <script>
        // Load deployment info and SKR config on page load
        window.onload = function() {
            // Load SKR configuration
            fetch('/skr/config')
                .then(response => response.json())
                .then(data => {
                    const skrConfigDiv = document.getElementById('skrConfigInfo');
                    if (data.configured) {
                        let html = '<div style="text-align: center; margin-bottom: 15px;">';
                        html += '<p style="color: #004085; font-size: 0.9em; margin-bottom: 5px;">TARGET KEY FOR SECURE KEY RELEASE</p>';
                        html += '<p style="color: #0078d4; font-size: 1.8em; font-weight: bold; font-family: monospace; background: white; padding: 12px 20px; border-radius: 6px; display: inline-block; border: 2px dashed #0078d4;">üîë ' + escapeHtml(data.key_name) + '</p>';
                        html += '</div>';
                        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9em;">';
                        html += '<div style="background: white; padding: 10px; border-radius: 4px;"><strong style="color: #666;">Key Vault:</strong><br><span style="color: #004085; font-family: monospace;">' + escapeHtml(data.akv_endpoint) + '</span></div>';
                        html += '<div style="background: white; padding: 10px; border-radius: 4px;"><strong style="color: #666;">MAA Endpoint:</strong><br><span style="color: #004085; font-family: monospace;">' + escapeHtml(data.maa_endpoint) + '</span></div>';
                        html += '</div>';
                        skrConfigDiv.innerHTML = html;
                    } else {
                        skrConfigDiv.innerHTML = '<p style="color: #856404;"><em>‚ö†Ô∏è SKR not configured. Deploy with -SKR parameter to enable Secure Key Release.</em></p>';
                        skrConfigDiv.style.background = '#fff3cd';
                        skrConfigDiv.style.borderColor = '#ffc107';
                        document.getElementById('skrBtn').disabled = true;
                        document.getElementById('skrBtn').title = 'SKR not configured';
                    }
                })
                .catch(error => {
                    document.getElementById('skrConfigInfo').innerHTML = 
                        '<p style="color: #856404;"><em>‚ö†Ô∏è Could not load SKR configuration: ' + escapeHtml(error.message) + '</em></p>';
                });
            
            // Check if a key has already been released (e.g., page refresh)
            checkKeyStatus();
            
            fetch('/info')
                .then(response => response.json())
                .then(data => {
                    // Only update header if attestation is verified - otherwise keep default
                    const header = document.querySelector('.header');
                    const headerH1 = header.querySelector('h1');
                    const headerP = header.querySelector('p');
                    
                    if (data.status && data.status.attestation_works) {
                        // Attestation verified - show green success header
                        header.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';
                        headerH1.innerHTML = 'üîí Confidential Azure Container Instances';
                        headerP.textContent = 'Running in AMD SEV-SNP Trusted Execution Environment';
                        
                        // Update security features to verified
                        updateSecurityFeatures(true, null, null);
                    }
                    // If attestation fails, keep the default header - user will see failure when they click the button
                    
                    // Build deployment info display - show basic info without failure details
                    let html = '<div class="info-grid">';
                    html += `<div class="info-card"><h3>Platform</h3><p>${data.platform || 'Azure Container Instances'}</p></div>`;
                    
                    // Show correct SKU and hardware based on attestation status
                    if (data.status && data.status.attestation_works) {
                        html += `<div class="info-card" style="border-left-color: #28a745;"><h3>SKU</h3><p>${data.sku || 'Confidential'}</p></div>`;
                        html += `<div class="info-card" style="border-left-color: #28a745;"><h3>Hardware</h3><p>${data.hardware || 'AMD SEV-SNP'}</p></div>`;
                        html += `<div class="info-card"><h3>Attestation</h3><p>${data.attestation_service || data.attestation || 'Microsoft Azure Attestation'}</p></div>`;
                    } else {
                        html += `<div class="info-card" style="border-left-color: #dc3545;"><h3>SKU</h3><p>Standard (No TEE)</p></div>`;
                        html += `<div class="info-card" style="border-left-color: #dc3545;"><h3>Hardware</h3><p>No Hardware Security</p></div>`;
                        html += `<div class="info-card" style="border-left-color: #dc3545;"><h3>Attestation</h3><p>Not Available</p></div>`;
                    }
                    html += '</div>';
                    
                    // Only show success status box if attestation works
                    if (data.status && data.status.attestation_works) {
                        html += '<div style="margin-top: 20px; padding: 20px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">';
                        html += '<h4 style="margin-bottom: 10px; color: #155724;">‚úì Live Attestation Status: VERIFIED</h4>';
                        html += '<p><strong>Sidecar Available:</strong> Yes</p>';
                        html += '<p><strong>Attestation Works:</strong> Yes</p>';
                        html += '</div>';
                        
                        if (data.diagnostics && data.diagnostics.recommendation) {
                            html += '<div style="margin-top: 15px; padding: 15px; background: #cce5ff; border-radius: 8px; border-left: 4px solid #0078d4;">';
                            html += '<p style="color: #004085;"><strong>üí° Status:</strong> ' + escapeHtml(data.diagnostics.recommendation) + '</p>';
                            html += '</div>';
                        }
                        
                        // Update features list for verified state
                        if (data.features && Array.isArray(data.features)) {
                            updateFeaturesFromInfo(data.features, true);
                        }
                    }
                    // Don't show failure details on page load - let user discover via attestation button
                    
                    document.getElementById('deploymentInfo').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('deploymentInfo').innerHTML = 
                        '<p class="status-badge status-error">Error loading deployment info: ' + escapeHtml(error.message) + '</p>';
                });
            
            // Load container image information
            fetch('/container/info')
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    
                    // Container identity
                    html += '<div style="margin-bottom: 20px;">';
                    html += '<h4 style="color: #495057; margin-bottom: 10px;">üè∑Ô∏è Container Identity</h4>';
                    html += '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<tr><td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-weight: bold; width: 200px;">Hostname</td>';
                    html += '<td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-family: monospace;">' + escapeHtml(data.hostname || 'Unknown') + '</td></tr>';
                    html += '<tr><td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-weight: bold;">Container ID</td>';
                    html += '<td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-family: monospace;">' + escapeHtml(data.container_id || 'Unknown') + '</td></tr>';
                    if (data.os) {
                        html += '<tr><td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-weight: bold;">OS</td>';
                        html += '<td style="padding: 8px; border-bottom: 1px solid #dee2e6;">' + escapeHtml(data.os.pretty_name || 'Unknown') + '</td></tr>';
                    }
                    html += '</table>';
                    html += '</div>';
                    
                    // SKR Service Status (important for NoAcc mode)
                    if (data.skr_status) {
                        const skrRunning = data.skr_status.running === true;
                        const statusColor = skrRunning ? '#28a745' : '#dc3545';
                        const statusIcon = skrRunning ? '‚úÖ' : '‚ùå';
                        
                        html += '<div style="margin-bottom: 20px; padding: 15px; border-radius: 8px; background: ' + (skrRunning ? '#d4edda' : '#f8d7da') + '; border-left: 4px solid ' + statusColor + ';">';
                        html += '<h4 style="color: ' + statusColor + '; margin-bottom: 10px;">' + statusIcon + ' SKR Service Status</h4>';
                        
                        if (skrRunning) {
                            html += '<p style="color: #155724;"><strong>Status:</strong> Running on port 8080</p>';
                        } else {
                            html += '<p style="color: #721c24;"><strong>Status:</strong> Not Running</p>';
                            if (data.skr_status.reason) {
                                html += '<p style="color: #721c24; margin-top: 10px;"><strong>Reason:</strong> ' + escapeHtml(data.skr_status.reason) + '</p>';
                            }
                            if (data.skr_status.explanation) {
                                html += '<div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 4px;">';
                                html += '<p style="color: #721c24; font-size: 0.9em;">' + escapeHtml(data.skr_status.explanation) + '</p>';
                                html += '</div>';
                            }
                            if (data.skr_status.solution) {
                                html += '<p style="color: #155724; margin-top: 10px; background: #d4edda; padding: 8px; border-radius: 4px;"><strong>üí° Solution:</strong> ' + escapeHtml(data.skr_status.solution) + '</p>';
                            }
                            if (data.skr_status.technical_detail) {
                                html += '<p style="color: #6c757d; margin-top: 10px; font-size: 0.85em;"><em>Technical: ' + escapeHtml(data.skr_status.technical_detail) + '</em></p>';
                            }
                        }
                        html += '</div>';
                    }
                    
                    // SEV Device Status
                    if (data.sev_device) {
                        const sevAvailable = data.sev_device.available;
                        const sevColor = sevAvailable ? '#28a745' : '#dc3545';
                        const sevIcon = sevAvailable ? '‚úÖ' : '‚ùå';
                        
                        html += '<div style="margin-bottom: 20px; padding: 15px; border-radius: 8px; background: ' + (sevAvailable ? '#d4edda' : '#f8d7da') + '; border-left: 4px solid ' + sevColor + ';">';
                        html += '<h4 style="color: ' + sevColor + '; margin-bottom: 10px;">' + sevIcon + ' AMD SEV-SNP Device</h4>';
                        
                        if (sevAvailable) {
                            html += '<p style="color: #155724;"><strong>Device:</strong> ' + escapeHtml(data.sev_device.device_path) + '</p>';
                        } else {
                            html += '<p style="color: #721c24;"><strong>Device:</strong> Not found (no /dev/sev-guest)</p>';
                            html += '<p style="color: #721c24; font-size: 0.9em; margin-top: 5px;"><em>This container is NOT running on confidential computing hardware.</em></p>';
                        }
                        html += '</div>';
                    }
                    
                    // SKR Binary Info with checksums
                    if (data.skr_binary_info && !data.skr_binary_info.error) {
                        html += '<div style="margin-bottom: 20px;">';
                        html += '<h4 style="color: #495057; margin-bottom: 10px;">üîê SKR Binary</h4>';
                        html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">';
                        html += '<tr><td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-weight: bold; width: 200px;">Path</td>';
                        html += '<td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-family: monospace;">' + escapeHtml(data.skr_binary_info.path) + '</td></tr>';
                        html += '<tr><td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-weight: bold;">Size</td>';
                        html += '<td style="padding: 8px; border-bottom: 1px solid #dee2e6;">' + (data.skr_binary_info.size_bytes ? (data.skr_binary_info.size_bytes / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown') + '</td></tr>';
                        html += '<tr><td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-weight: bold;">MD5</td>';
                        html += '<td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-family: monospace; font-size: 0.85em;">' + escapeHtml(data.skr_binary_info.md5 || 'N/A') + '</td></tr>';
                        html += '<tr><td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-weight: bold;">SHA256 (partial)</td>';
                        html += '<td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-family: monospace; font-size: 0.85em;">' + escapeHtml(data.skr_binary_info.sha256 || 'N/A') + '</td></tr>';
                        html += '<tr><td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-weight: bold;">Executable</td>';
                        html += '<td style="padding: 8px; border-bottom: 1px solid #dee2e6;">' + (data.skr_binary_info.executable ? '‚úì Yes' : '‚úó No') + '</td></tr>';
                        if (data.skr_binary_info.version) {
                            html += '<tr><td style="padding: 8px; border-bottom: 1px solid #dee2e6; font-weight: bold;">Version</td>';
                            html += '<td style="padding: 8px; border-bottom: 1px solid #dee2e6;">' + escapeHtml(data.skr_binary_info.version) + '</td></tr>';
                        }
                        html += '</table>';
                        html += '</div>';
                    }
                    
                    // Application file checksums
                    if (data.app_checksums && Object.keys(data.app_checksums).length > 0) {
                        html += '<div style="margin-bottom: 20px;">';
                        html += '<h4 style="color: #495057; margin-bottom: 10px;">üìÑ Application Files (MD5 Checksums)</h4>';
                        html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">';
                        for (const [path, info] of Object.entries(data.app_checksums)) {
                            if (info.md5) {
                                html += '<tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6; font-family: monospace; word-break: break-all;">' + escapeHtml(path) + '</td>';
                                html += '<td style="padding: 6px; border-bottom: 1px solid #dee2e6; font-family: monospace; color: #0078d4;">' + escapeHtml(info.md5) + '</td>';
                                html += '<td style="padding: 6px; border-bottom: 1px solid #dee2e6; color: #6c757d;">' + (info.size_bytes ? (info.size_bytes / 1024).toFixed(1) + ' KB' : '') + '</td></tr>';
                            }
                        }
                        html += '</table>';
                        html += '</div>';
                    }
                    
                    document.getElementById('containerInfo').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('containerInfo').innerHTML = 
                        '<p style="color: #dc3545;">Error loading container info: ' + escapeHtml(error.message) + '</p>';
                });
        };
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Update features list from /info response
        function updateFeaturesFromInfo(features, isVerified) {
            const featuresList = document.getElementById('featuresList');
            let html = '';
            features.forEach(feature => {
                const isNegative = feature.includes('NOT') || feature.includes('FAILED');
                const className = isNegative ? 'unverified' : (isVerified ? 'verified' : 'pending');
                const icon = isNegative ? '‚úó' : (isVerified ? '‚úì' : '‚óã');
                html += `<li class="${className}"><span class="status-icon">${icon}</span> ${escapeHtml(feature)}</li>`;
            });
            featuresList.innerHTML = html;
        }
        
        // Function to show attestation failure in the header and page
        function showAttestationFailure(errorMessage, data) {
            const header = document.querySelector('.header');
            const headerH1 = header.querySelector('h1');
            const headerP = header.querySelector('p');
            
            header.style.background = 'linear-gradient(135deg, #dc3545 0%, #a71d2a 100%)';
            headerH1.innerHTML = '‚ö†Ô∏è Standard Azure Container Instances';
            headerP.textContent = 'NOT running on confidential hardware - Attestation Failed';
            
            // Update the deployment info section to show failure
            let html = '<div class="info-grid">';
            html += `<div class="info-card"><h3>Platform</h3><p>Azure Container Instances</p></div>`;
            html += `<div class="info-card" style="border-left-color: #dc3545;"><h3>SKU</h3><p>Standard (No TEE)</p></div>`;
            html += `<div class="info-card" style="border-left-color: #dc3545;"><h3>Hardware</h3><p>No Hardware Security</p></div>`;
            html += `<div class="info-card"><h3>Attestation</h3><p>Failed</p></div>`;
            html += '</div>';
            
            // Show failure status box
            html += '<div style="margin-top: 20px; padding: 20px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">';
            html += '<h4 style="margin-bottom: 10px; color: #721c24;">‚úó Live Attestation Status: FAILED</h4>';
            html += '<p><strong>Error:</strong> ' + escapeHtml(errorMessage) + '</p>';
            
            if (data && data.failure_reason) {
                html += '<p style="margin-top: 10px;"><strong>Reason:</strong> ' + escapeHtml(data.failure_reason) + '</p>';
            }
            
            if (data && data.diagnosis && data.diagnosis.solution) {
                html += '<p style="margin-top: 10px;"><strong>Solution:</strong> ' + escapeHtml(data.diagnosis.solution) + '</p>';
            }
            
            html += '</div>';
            
            document.getElementById('deploymentInfo').innerHTML = html;
        }
        
        function requestAttestation() {
            const btn = document.getElementById('attestBtn');
            const resultDiv = document.getElementById('attestResult');
            
            btn.disabled = true;
            btn.innerHTML = 'Requesting Attestation<span class="loading"></span>';
            
            resultDiv.innerHTML = '<p>Contacting Microsoft Azure Attestation service...</p>';
            
            fetch('/attest/maa', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    maa_endpoint: 'sharedeus.eus.attest.azure.net',
                    runtime_data: btoa(JSON.stringify({
                        timestamp: new Date().toISOString(),
                        demo: 'Confidential ACI Attestation Demo'
                    }))
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().catch(() => {
                        throw new Error('Server returned error: ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = 'Request Attestation Token';
                
                if (data.status === 'success') {
                    // Parse the JWT token
                    try {
                        const parts = data.attestation_token.split('.');
                        const payload = JSON.parse(atob(parts[1]));
                        
                        // Update security features based on attestation claims
                        updateSecurityFeatures(true, payload);
                        
                        let html = '<div style="margin-top: 20px;">';
                        html += '<p><span class="status-badge status-success">Attestation Successful</span></p>';
                        html += '<p style="margin: 15px 0;"><strong>MAA Endpoint:</strong> ' + data.maa_endpoint + '</p>';
                        html += '<p style="margin: 15px 0;"><strong>Token Claims:</strong></p>';
                        html += '<div class="output-box"><pre>' + JSON.stringify(payload, null, 2) + '</pre></div>';
                        html += '</div>';
                        
                        resultDiv.innerHTML = html;
                    } catch (e) {
                        // Token received but couldn't parse - partial success
                        updateSecurityFeatures(false, null, 'Could not parse attestation token');
                        resultDiv.innerHTML = 
                            '<p><span class="status-badge status-warning">Attestation Token Received (Parse Error)</span></p>' +
                            '<div class="output-box"><pre>' + data.attestation_token + '</pre></div>';
                    }
                } else {
                    // Attestation failed - update header and page to show failure
                    updateSecurityFeatures(false, null, data.message || 'Attestation failed');
                    showAttestationFailure(data.message || 'Attestation failed', data);
                    
                    let errorHtml = '<div style="margin-top: 20px;">';
                    errorHtml += '<p><span class="status-badge status-error">Attestation Failed</span></p>';
                    errorHtml += '<p style="margin: 15px 0;"><strong>Error:</strong> ' + escapeHtml(data.message || 'Unknown error') + '</p>';
                    
                    // Show failure reason if available
                    if (data.failure_reason) {
                        errorHtml += '<div style="margin: 15px 0; padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">';
                        errorHtml += '<p style="color: #721c24; font-weight: bold;">üîç Failure Reason:</p>';
                        errorHtml += '<p style="margin-top: 10px; color: #721c24;">' + escapeHtml(data.failure_reason) + '</p>';
                        errorHtml += '</div>';
                    }
                    
                    // Show diagnosis if available
                    if (data.diagnosis) {
                        errorHtml += '<div style="margin: 15px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">';
                        errorHtml += '<p style="color: #856404; font-weight: bold;">üí° Diagnosis:</p>';
                        if (data.diagnosis.likely_cause) {
                            errorHtml += '<p style="margin-top: 10px; color: #856404;"><strong>Likely Cause:</strong> ' + escapeHtml(data.diagnosis.likely_cause) + '</p>';
                        }
                        if (data.diagnosis.solution) {
                            errorHtml += '<p style="margin-top: 5px; color: #856404;"><strong>Solution:</strong> ' + escapeHtml(data.diagnosis.solution) + '</p>';
                        }
                        if (data.diagnosis.command) {
                            errorHtml += '<p style="margin-top: 10px;"><code style="background: #333; color: #0f0; padding: 8px 12px; border-radius: 4px; display: inline-block;">' + escapeHtml(data.diagnosis.command) + '</code></p>';
                        }
                        errorHtml += '</div>';
                    }
                    
                    // Show sidecar response if available
                    if (data.sidecar_response) {
                        errorHtml += '<div style="margin: 15px 0;">';
                        errorHtml += '<p><strong>Sidecar Response (Status ' + (data.sidecar_status_code || 'unknown') + '):</strong></p>';
                        errorHtml += '<div class="output-box" style="background: #2d2d2d; border-left: 3px solid #dc3545;"><pre style="color: #f8d7da;">' + 
                            escapeHtml(data.sidecar_response) + '</pre></div></div>';
                    }
                    
                    if (data.note) {
                        errorHtml += '<p style="margin: 15px 0; padding: 10px; background: #e2e3e5; border-radius: 5px; color: #383d41;"><em>‚ÑπÔ∏è ' + escapeHtml(data.note) + '</em></p>';
                    }
                    
                    // Show service logs if available
                    if (data.logs) {
                        // Minimize logs for non-confidential (snooper) containers
                        var detailsAttr = isConfidentialContainer ? 'open' : '';
                        errorHtml += '<details ' + detailsAttr + ' style="margin: 20px 0; border: 1px solid #6c757d; border-radius: 8px; overflow: hidden;">';
                        errorHtml += '<summary style="padding: 15px; background: #343a40; color: #fff; cursor: pointer; font-weight: bold;">üìã Service Logs</summary>';
                        errorHtml += '<div style="padding: 15px; background: #1e1e1e;">';
                        
                        // SEV-SNP Device Status - FIRST (most important for diagnosing failures)
                        if (data.logs.sev_device) {
                            const sevDevice = data.logs.sev_device;
                            const sevAvailable = sevDevice.available;
                            const sevColor = sevAvailable ? '#28a745' : '#dc3545';
                            const sevIcon = sevAvailable ? '‚úÖ' : '‚ùå';
                            
                            errorHtml += '<div style="margin-bottom: 15px; padding: 15px; border-radius: 8px; background: ' + (sevAvailable ? '#d4edda' : '#f8d7da') + '; border-left: 4px solid ' + sevColor + ';">';
                            errorHtml += '<h4 style="color: ' + sevColor + '; margin-bottom: 10px;">' + sevIcon + ' AMD SEV-SNP Device Status</h4>';
                            
                            if (sevAvailable) {
                                errorHtml += '<p style="color: #155724;"><strong>Device Found:</strong> ' + escapeHtml(sevDevice.device_path) + '</p>';
                                if (sevDevice.device_info && typeof sevDevice.device_info === 'object') {
                                    errorHtml += '<p style="color: #155724;"><strong>Type:</strong> ' + escapeHtml(sevDevice.device_info.type) + '</p>';
                                    errorHtml += '<p style="color: #155724;"><strong>Accessible:</strong> ' + (sevDevice.device_info.accessible ? 'Yes' : 'No') + '</p>';
                                }
                            } else {
                                errorHtml += '<p style="color: #721c24;"><strong>Device Not Found</strong></p>';
                                if (sevDevice.dev_listing && sevDevice.dev_listing.length > 0) {
                                    errorHtml += '<p style="color: #721c24;"><strong>Related devices in /dev:</strong> ' + escapeHtml(sevDevice.dev_listing.join(', ')) + '</p>';
                                } else {
                                    errorHtml += '<p style="color: #721c24;"><strong>Related devices in /dev:</strong> None found (no sev, tpm, or sgx devices)</p>';
                                }
                            }
                            
                            errorHtml += '<p style="margin-top: 10px; color: ' + (sevAvailable ? '#155724' : '#721c24') + ';"><em>' + escapeHtml(sevDevice.explanation) + '</em></p>';
                            errorHtml += '</div>';
                        }
                        
                        // SKR logs
                        errorHtml += '<div style="margin-bottom: 15px;">';
                        errorHtml += '<h4 style="color: #17a2b8; margin-bottom: 10px;">üîê SKR Service Log</h4>';
                        errorHtml += '<div class="output-box" style="max-height: 200px; overflow-y: auto;"><pre>' + escapeHtml(data.logs.skr || '(not available)') + '</pre></div>';
                        errorHtml += '</div>';
                        
                        // SKR error logs
                        errorHtml += '<div style="margin-bottom: 15px;">';
                        errorHtml += '<h4 style="color: #dc3545; margin-bottom: 10px;">‚ùå SKR Error Log</h4>';
                        errorHtml += '<div class="output-box" style="max-height: 200px; overflow-y: auto; border-left: 3px solid #dc3545;"><pre style="color: #f8d7da;">' + escapeHtml(data.logs.skr_error || '(not available)') + '</pre></div>';
                        errorHtml += '</div>';
                        
                        // Flask logs
                        errorHtml += '<div style="margin-bottom: 15px;">';
                        errorHtml += '<h4 style="color: #28a745; margin-bottom: 10px;">üåê Flask App Log</h4>';
                        errorHtml += '<div class="output-box" style="max-height: 200px; overflow-y: auto;"><pre>' + escapeHtml(data.logs.flask || '(not available)') + '</pre></div>';
                        errorHtml += '</div>';
                        
                        // Flask error logs
                        errorHtml += '<div style="margin-bottom: 15px;">';
                        errorHtml += '<h4 style="color: #dc3545; margin-bottom: 10px;">‚ùå Flask Error Log</h4>';
                        errorHtml += '<div class="output-box" style="max-height: 200px; overflow-y: auto; border-left: 3px solid #dc3545;"><pre style="color: #f8d7da;">' + escapeHtml(data.logs.flask_error || '(not available)') + '</pre></div>';
                        errorHtml += '</div>';
                        
                        // Supervisord log
                        errorHtml += '<div style="margin-bottom: 15px;">';
                        errorHtml += '<h4 style="color: #ffc107; margin-bottom: 10px;">‚öôÔ∏è Supervisord Log</h4>';
                        errorHtml += '<div class="output-box" style="max-height: 200px; overflow-y: auto;"><pre>' + escapeHtml(data.logs.supervisord || '(not available)') + '</pre></div>';
                        errorHtml += '</div>';
                        
                        errorHtml += '</div></details>';
                    }
                    
                    errorHtml += '</div>';
                    resultDiv.innerHTML = errorHtml;
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = 'Request Attestation Token';
                // Attestation request failed - also update header
                showAttestationFailure(error.message, null);
                updateSecurityFeatures(false, null, error.message);
                resultDiv.innerHTML = 
                    '<p><span class="status-badge status-error">Request Failed</span></p>' +
                    '<p style="margin: 15px 0;"><strong>Error:</strong> ' + error.message + '</p>' +
                    '<p style="margin: 15px 0; padding: 10px; background: #fff3cd; border-radius: 5px; color: #856404;">' +
                    '<em>üí° This demo requires deployment with the attestation sidecar. ' +
                    'Deploy using azure-aci-custom-demo.ps1 with Confidential SKU to enable attestation.</em></p>';
            });
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Function to update security features based on attestation result
        function updateSecurityFeatures(verified, payload, errorMessage) {
            const featuresList = document.getElementById('featuresList');
            const statusEl = document.getElementById('securityStatus');
            const features = featuresList.querySelectorAll('li');
            
            if (verified && payload) {
                // Attestation successful - check specific claims
                statusEl.innerHTML = '<span style="color: #28a745;">‚úì Attestation verified successfully</span>';
                statusEl.style.color = '#28a745';
                
                features.forEach(li => {
                    li.className = 'verified';
                    li.querySelector('.status-icon').textContent = '‚úì';
                });
                
                // Check specific claims from the attestation payload
                const claims = {
                    tee: payload['x-ms-isolation-tee'] || payload['x-ms-sevsnpvm-is-debuggable'] === false,
                    memory: payload['x-ms-sevsnpvm-vmpl'] !== undefined || payload['x-ms-isolation-tee'],
                    confidentiality: payload['x-ms-compliance-status'] === 'azure-compliant-cvm' || payload['x-ms-isolation-tee'],
                    policy: payload['x-ms-sevsnpvm-hostdata'] !== undefined,
                    attestation: true, // We got a valid token
                    protection: payload['x-ms-sevsnpvm-is-debuggable'] === false || payload['x-ms-isolation-tee']
                };
                
                features.forEach(li => {
                    const feature = li.dataset.feature;
                    if (claims[feature] === false) {
                        li.className = 'unverified';
                        li.querySelector('.status-icon').textContent = '‚úó';
                    }
                });
            } else {
                // Attestation failed
                statusEl.innerHTML = '<span style="color: #dc3545;">‚úó Attestation failed: ' + (errorMessage || 'Unknown error') + '</span>';
                statusEl.style.color = '#dc3545';
                
                features.forEach(li => {
                    li.className = 'unverified';
                    li.querySelector('.status-icon').textContent = '‚úó';
                });
            }
        }
        
        function testSecureKeyRelease() {
            const btn = document.getElementById('skrBtn');
            const resultDiv = document.getElementById('skrResult');
            
            btn.disabled = true;
            btn.innerHTML = 'üîê Releasing Key<span class="loading"></span>';
            
            resultDiv.innerHTML = '<p>Requesting secure key release from Azure Key Vault...</p>';
            
            fetch('/skr/release', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = 'üîê Test Secure Key Release';
                
                if (data.status === 'success') {
                    let html = '<div style="margin-top: 20px;">';
                    html += '<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">';
                    html += '<span style="font-size: 3em; color: #28a745;">‚úì</span>';
                    html += '<div>';
                    html += '<p><span class="status-badge status-success">Secure Key Release Successful</span></p>';
                    html += '<p style="margin-top: 10px; color: #155724;">The key was successfully released by Azure Key Vault to this verified confidential container.</p>';
                    html += '</div>';
                    html += '</div>';
                    
                    // Show SKR details
                    html += '<div style="padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 20px;">';
                    html += '<h4 style="color: #155724; margin-bottom: 10px;">üîë Key Release Details</h4>';
                    html += '<p style="color: #155724;"><strong>Key Vault:</strong> ' + escapeHtml(data.akv_endpoint || 'N/A') + '</p>';
                    html += '<p style="color: #155724;"><strong>Key Name:</strong> ' + escapeHtml(data.key_name || 'N/A') + '</p>';
                    html += '<p style="color: #155724;"><strong>MAA Endpoint:</strong> ' + escapeHtml(data.maa_endpoint || 'N/A') + '</p>';
                    html += '</div>';
                    
                    // Show the released key
                    html += '<p style="margin: 15px 0;"><strong>Released Key (JWK format):</strong></p>';
                    html += '<div class="output-box" style="border-left: 4px solid #28a745;"><pre>' + JSON.stringify(data.key, null, 2) + '</pre></div>';
                    
                    html += '</div>';
                    resultDiv.innerHTML = html;
                    
                    // Enable the real-time encryption UI
                    enableEncryptionUI();
                } else {
                    // SKR failed
                    let errorHtml = '<div style="margin-top: 20px;">';
                    errorHtml += '<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">';
                    errorHtml += '<span style="font-size: 3em; color: #dc3545;">‚úó</span>';
                    errorHtml += '<div>';
                    errorHtml += '<p><span class="status-badge status-error">Secure Key Release Failed</span></p>';
                    errorHtml += '<p style="margin-top: 10px; color: #721c24;">' + escapeHtml(data.message || 'Unknown error') + '</p>';
                    errorHtml += '</div>';
                    errorHtml += '</div>';
                    
                    // Show SKR configuration
                    errorHtml += '<div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6c757d; margin-bottom: 20px;">';
                    errorHtml += '<h4 style="color: #495057; margin-bottom: 10px;">üîß SKR Configuration</h4>';
                    errorHtml += '<p><strong>Key Vault:</strong> ' + escapeHtml(data.akv_endpoint || 'Not configured') + '</p>';
                    errorHtml += '<p><strong>Key Name:</strong> ' + escapeHtml(data.key_name || 'Not configured') + '</p>';
                    errorHtml += '<p><strong>MAA Endpoint:</strong> ' + escapeHtml(data.maa_endpoint || 'Not configured') + '</p>';
                    errorHtml += '</div>';
                    
                    // Show failure reason if available
                    if (data.failure_reason) {
                        errorHtml += '<div style="margin: 15px 0; padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">';
                        errorHtml += '<p style="color: #721c24; font-weight: bold;">üîç Failure Reason:</p>';
                        errorHtml += '<p style="margin-top: 10px; color: #721c24;">' + escapeHtml(data.failure_reason) + '</p>';
                        errorHtml += '</div>';
                    }
                    
                    // Show diagnosis if available
                    if (data.diagnosis) {
                        errorHtml += '<div style="margin: 15px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">';
                        errorHtml += '<p style="color: #856404; font-weight: bold;">üí° Diagnosis:</p>';
                        if (data.diagnosis.likely_cause) {
                            errorHtml += '<p style="margin-top: 10px; color: #856404;"><strong>Likely Cause:</strong> ' + escapeHtml(data.diagnosis.likely_cause) + '</p>';
                        }
                        if (data.diagnosis.solution) {
                            errorHtml += '<p style="margin-top: 5px; color: #856404;"><strong>Solution:</strong> ' + escapeHtml(data.diagnosis.solution) + '</p>';
                        }
                        errorHtml += '</div>';
                    }
                    
                    // Show sidecar response if available
                    if (data.sidecar_response) {
                        errorHtml += '<div style="margin: 15px 0;">';
                        errorHtml += '<p><strong>SKR Sidecar Response (Status ' + (data.sidecar_status_code || 'unknown') + '):</strong></p>';
                        errorHtml += '<div class="output-box" style="background: #2d2d2d; border-left: 3px solid #dc3545;"><pre style="color: #f8d7da;">' + 
                            escapeHtml(data.sidecar_response) + '</pre></div></div>';
                    }
                    
                    // Show service logs if available
                    if (data.logs) {
                        // Minimize logs for non-confidential (snooper) containers
                        var detailsAttr = isConfidentialContainer ? 'open' : '';
                        errorHtml += '<details ' + detailsAttr + ' style="margin: 20px 0; border: 1px solid #6c757d; border-radius: 8px; overflow: hidden;">';
                        errorHtml += '<summary style="padding: 15px; background: #343a40; color: #fff; cursor: pointer; font-weight: bold;">üìã Service Logs</summary>';
                        errorHtml += '<div style="padding: 15px; background: #1e1e1e;">';
                        
                        // SEV-SNP Device Status
                        if (data.logs.sev_device) {
                            const sevDevice = data.logs.sev_device;
                            const sevAvailable = sevDevice.available;
                            const sevColor = sevAvailable ? '#28a745' : '#dc3545';
                            const sevIcon = sevAvailable ? '‚úÖ' : '‚ùå';
                            
                            errorHtml += '<div style="margin-bottom: 15px; padding: 15px; border-radius: 8px; background: ' + (sevAvailable ? '#d4edda' : '#f8d7da') + '; border-left: 4px solid ' + sevColor + ';">';
                            errorHtml += '<h4 style="color: ' + sevColor + '; margin-bottom: 10px;">' + sevIcon + ' AMD SEV-SNP Device Status</h4>';
                            
                            if (sevAvailable) {
                                errorHtml += '<p style="color: #155724;"><strong>Device Found:</strong> ' + escapeHtml(sevDevice.device_path) + '</p>';
                            } else {
                                errorHtml += '<p style="color: #721c24;"><strong>Device Not Found</strong></p>';
                                errorHtml += '<p style="color: #721c24;"><em>SKR requires AMD SEV-SNP hardware (Confidential ACI)</em></p>';
                            }
                            
                            errorHtml += '<p style="margin-top: 10px; color: ' + (sevAvailable ? '#155724' : '#721c24') + ';"><em>' + escapeHtml(sevDevice.explanation) + '</em></p>';
                            errorHtml += '</div>';
                        }
                        
                        // SKR logs
                        errorHtml += '<div style="margin-bottom: 15px;">';
                        errorHtml += '<h4 style="color: #17a2b8; margin-bottom: 10px;">üîê SKR Service Log</h4>';
                        errorHtml += '<div class="output-box" style="max-height: 200px; overflow-y: auto;"><pre>' + escapeHtml(data.logs.skr || '(not available)') + '</pre></div>';
                        errorHtml += '</div>';
                        
                        // SKR error logs
                        errorHtml += '<div style="margin-bottom: 15px;">';
                        errorHtml += '<h4 style="color: #dc3545; margin-bottom: 10px;">‚ùå SKR Error Log</h4>';
                        errorHtml += '<div class="output-box" style="max-height: 200px; overflow-y: auto; border-left: 3px solid #dc3545;"><pre style="color: #f8d7da;">' + escapeHtml(data.logs.skr_error || '(not available)') + '</pre></div>';
                        errorHtml += '</div>';
                        
                        errorHtml += '</div></details>';
                    }
                    
                    errorHtml += '</div>';
                    resultDiv.innerHTML = errorHtml;
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = 'üîê Test Secure Key Release';
                resultDiv.innerHTML = 
                    '<p><span class="status-badge status-error">Request Failed</span></p>' +
                    '<p style="margin: 15px 0;"><strong>Error:</strong> ' + escapeHtml(error.message) + '</p>' +
                    '<p style="margin: 15px 0; padding: 10px; background: #fff3cd; border-radius: 5px; color: #856404;">' +
                    '<em>üí° Secure Key Release requires the SKR sidecar and Key Vault configuration. ' +
                    'Deploy using -SKR parameter to enable this feature.</em></p>';
            });
        }
        
        // Debounce timer for real-time encryption
        let encryptionTimer = null;
        
        function enableEncryptionUI() {
            // Enable the encryption text box and update status
            const statusDiv = document.getElementById('encryptionStatus');
            const plaintextInput = document.getElementById('plaintextInput');
            const encryptionInfo = document.getElementById('encryptionInfo');
            
            statusDiv.style.background = '#d4edda';
            statusDiv.style.borderLeftColor = '#28a745';
            statusDiv.innerHTML = '<p style="color: #155724;"><strong>‚úÖ Key released successfully!</strong> You can now encrypt text in real-time.</p>';
            
            plaintextInput.disabled = false;
            plaintextInput.placeholder = 'Type your secret message here...';
            plaintextInput.focus();
            
            encryptionInfo.style.display = 'block';
            
            // Update max plaintext length (assuming 4096-bit key = 446 bytes max for RSA-OAEP-SHA256)
            document.getElementById('maxPlaintextLength').textContent = '446';
            
            // Show the Company Secure Data Entry section after SKR success
            checkCompanyDataAccess();
        }
        
        function encryptRealtime() {
            const plaintextInput = document.getElementById('plaintextInput');
            const ciphertextOutput = document.getElementById('ciphertextOutput');
            const plaintextLengthSpan = document.getElementById('plaintextLength');
            const ciphertextLengthSpan = document.getElementById('ciphertextLength');
            
            const plaintext = plaintextInput.value;
            plaintextLengthSpan.textContent = plaintext.length;
            
            // Clear previous timer
            if (encryptionTimer) {
                clearTimeout(encryptionTimer);
            }
            
            if (!plaintext) {
                ciphertextOutput.value = '';
                ciphertextLengthSpan.textContent = '0';
                return;
            }
            
            // Debounce: wait 200ms after user stops typing
            encryptionTimer = setTimeout(() => {
                ciphertextOutput.value = 'Encrypting...';
                ciphertextOutput.style.borderColor = '#ffc107';
                
                fetch('/encrypt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ plaintext: plaintext })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        ciphertextOutput.value = data.ciphertext;
                        ciphertextOutput.style.borderColor = '#28a745';
                        ciphertextLengthSpan.textContent = data.ciphertext_length;
                    } else {
                        ciphertextOutput.value = 'Error: ' + (data.message || 'Encryption failed');
                        ciphertextOutput.style.borderColor = '#dc3545';
                        ciphertextLengthSpan.textContent = '0';
                    }
                })
                .catch(error => {
                    ciphertextOutput.value = 'Error: ' + error.message;
                    ciphertextOutput.style.borderColor = '#dc3545';
                    ciphertextLengthSpan.textContent = '0';
                });
            }, 200);
        }
        
        // Check key status on page load
        function checkKeyStatus() {
            fetch('/skr/key-status')
                .then(response => response.json())
                .then(data => {
                    if (data.released) {
                        enableEncryptionUI();
                    }
                })
                .catch(() => {
                    // Ignore errors - key just not available yet
                });
        }
        
        function requestRawAttestation() {
            const btn = document.getElementById('rawBtn');
            const resultDiv = document.getElementById('attestResult');
            
            btn.disabled = true;
            btn.innerHTML = 'Getting Report<span class="loading"></span>';
            
            resultDiv.innerHTML = '<p>Retrieving raw attestation report...</p>';
            
            fetch('/attest/raw', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    runtime_data: btoa('Raw Report - ' + new Date().toISOString())
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().catch(() => {
                        throw new Error('Server returned error: ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = 'Get Raw Attestation Report';
                
                if (data.status === 'success') {
                    resultDiv.innerHTML = 
                        '<div style="margin-top: 20px;">' +
                        '<p><span class="status-badge status-success">Raw Report Retrieved</span></p>' +
                        '<div class="output-box"><pre>' + data.attestation_report + '</pre></div>' +
                        '</div>';
                } else {
                    let errorHtml = '<div style="margin-top: 20px;">';
                    errorHtml += '<p><span class="status-badge status-error">Raw Attestation Failed</span></p>';
                    errorHtml += '<p style="margin: 15px 0;"><strong>Error:</strong> ' + escapeHtml(data.message || 'Unknown error') + '</p>';
                    
                    // Show failure reason if available
                    if (data.failure_reason) {
                        errorHtml += '<div style="margin: 15px 0; padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">';
                        errorHtml += '<p style="color: #721c24; font-weight: bold;">üîç Failure Reason:</p>';
                        errorHtml += '<p style="margin-top: 10px; color: #721c24;">' + escapeHtml(data.failure_reason) + '</p>';
                        errorHtml += '</div>';
                    }
                    
                    // Show diagnosis if available
                    if (data.diagnosis) {
                        errorHtml += '<div style="margin: 15px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">';
                        errorHtml += '<p style="color: #856404; font-weight: bold;">üí° Diagnosis:</p>';
                        if (data.diagnosis.likely_cause) {
                            errorHtml += '<p style="margin-top: 10px; color: #856404;"><strong>Likely Cause:</strong> ' + escapeHtml(data.diagnosis.likely_cause) + '</p>';
                        }
                        if (data.diagnosis.detail) {
                            errorHtml += '<p style="margin-top: 5px; color: #856404;"><strong>Detail:</strong> ' + escapeHtml(data.diagnosis.detail) + '</p>';
                        }
                        if (data.diagnosis.solution) {
                            errorHtml += '<p style="margin-top: 5px; color: #856404;"><strong>Solution:</strong> ' + escapeHtml(data.diagnosis.solution) + '</p>';
                        }
                        errorHtml += '</div>';
                    }
                    
                    // Show sidecar response if available
                    if (data.sidecar_response) {
                        errorHtml += '<div style="margin: 15px 0;">';
                        errorHtml += '<p><strong>Sidecar Response (Status ' + (data.sidecar_status_code || 'unknown') + '):</strong></p>';
                        errorHtml += '<div class="output-box" style="background: #2d2d2d; border-left: 3px solid #dc3545;"><pre style="color: #f8d7da;">' + 
                            escapeHtml(data.sidecar_response) + '</pre></div></div>';
                    }
                    
                    if (data.note) {
                        errorHtml += '<p style="margin: 15px 0; padding: 10px; background: #e2e3e5; border-radius: 5px; color: #383d41;"><em>‚ÑπÔ∏è ' + escapeHtml(data.note) + '</em></p>';
                    }
                    
                    errorHtml += '</div>';
                    resultDiv.innerHTML = errorHtml;
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = 'Get Raw Attestation Report';
                resultDiv.innerHTML = 
                    '<p><span class="status-badge status-error">Request Failed</span></p>' +
                    '<p style="margin: 15px 0;"><strong>Error:</strong> ' + error.message + '</p>' +
                    '<p style="margin: 15px 0; padding: 10px; background: #fff3cd; border-radius: 5px; color: #856404;">' +
                    '<em>üí° This demo requires deployment with the attestation sidecar. ' +
                    'Deploy using azure-aci-custom-demo.ps1 with Confidential SKU to enable attestation.</em></p>';
            });
        }
        
        // ============================================================================
        // External Blob Storage Functions
        // ============================================================================
        
        function loadStorageConfig() {
            fetch('/storage/config')
                .then(response => response.json())
                .then(data => {
                    // Store the consolidated blob name for snooper mode
                    if (data.consolidated_blob_name) {
                        consolidatedBlobName = data.consolidated_blob_name;
                    }
                    
                    const configDiv = document.getElementById('storageConfigInfo');
                    let html = '<div style="text-align: center;">';
                    html += '<p style="color: #856404; font-size: 0.9em; margin-bottom: 5px;">EXTERNAL BLOB STORAGE (PUBLIC ACCESS)</p>';
                    html += '<p style="color: #fd7e14; font-size: 1.2em; font-weight: bold; font-family: monospace;">' + escapeHtml(data.storage_account) + '</p>';
                    html += '<p style="color: #856404; font-size: 0.9em;">Container: <strong>' + escapeHtml(data.container_name) + '</strong></p>';
                    
                    // Display SAS token expiry information
                    if (data.sas_expiry && !data.sas_expiry.error) {
                        const expiry = data.sas_expiry;
                        let expiryColor = '#198754'; // green
                        let expiryIcon = '&#9989;'; // checkmark
                        
                        if (expiry.is_expired) {
                            expiryColor = '#dc3545'; // red
                            expiryIcon = '&#10060;'; // X
                        } else if (expiry.is_expiring_soon) {
                            expiryColor = '#fd7e14'; // orange
                            expiryIcon = '&#9888;'; // warning
                        }
                        
                        html += '<div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 6px;">';
                        html += '<p style="color: ' + expiryColor + '; font-size: 0.85em; margin-bottom: 5px;">SAS Token Expiry:</p>';
                        html += '<p style="color: ' + expiryColor + '; font-weight: bold;">' + expiryIcon + ' ' + escapeHtml(expiry.expiry_formatted) + '</p>';
                        
                        if (expiry.is_expired) {
                            html += '<p style="color: #dc3545; font-size: 0.9em; font-weight: bold;">&#128683; EXPIRED ' + Math.abs(expiry.days_remaining) + ' days ago</p>';
                        } else {
                            html += '<p style="color: ' + expiryColor + '; font-size: 0.9em;">' + expiry.days_remaining + ' days remaining</p>';
                        }
                        html += '</div>';
                    } else if (data.sas_expiry && data.sas_expiry.error) {
                        html += '<p style="color: #6c757d; font-size: 0.8em; margin-top: 5px;">Could not parse SAS expiry</p>';
                    } else if (!data.authenticated) {
                        html += '<p style="color: #6c757d; font-size: 0.8em; margin-top: 5px;">No SAS token configured</p>';
                    }
                    
                    html += '</div>';
                    configDiv.innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('storageConfigInfo').innerHTML = 
                        '<p style="color: #856404;"><em>‚ö†Ô∏è Could not load storage configuration</em></p>';
                });
        }
        
        function listBlobStorage() {
            const btn = document.getElementById('listBlobsBtn');
            const refreshBtn = document.getElementById('refreshBlobsBtn');
            const resultDiv = document.getElementById('blobListResult');
            
            btn.disabled = true;
            btn.innerHTML = 'üìÇ Loading<span class="loading"></span>';
            
            fetch('/storage/list')
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = 'üìÇ List Blob Contents';
                    refreshBtn.disabled = false;
                    
                    if (data.status === 'success') {
                        let html = '<div style="padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 15px;">';
                        html += '<p style="color: #155724;"><strong>‚úì Successfully accessed external storage!</strong></p>';
                        html += '<p style="color: #155724; font-size: 0.9em;">' + escapeHtml(data.security_note) + '</p>';
                        html += '</div>';
                        
                        if (data.blob_count === 0) {
                            html += '<div style="padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center;">';
                            html += '<p style="color: #6c757d;">üì≠ No blobs found in container</p>';
                            html += '<p style="color: #6c757d; font-size: 0.9em;">Upload files using Azure CLI or Storage Explorer</p>';
                            html += '</div>';
                        } else {
                            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                            html += '<thead><tr style="background: #f8f9fa;">';
                            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Name</th>';
                            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Size</th>';
                            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Type</th>';
                            html += '<th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;">Actions</th>';
                            html += '</tr></thead><tbody>';
                            
                            data.blobs.forEach(function(blob) {
                                html += '<tr style="border-bottom: 1px solid #dee2e6;">';
                                html += '<td style="padding: 10px;"><code>' + escapeHtml(blob.name) + '</code></td>';
                                html += '<td style="padding: 10px;">' + formatBytes(parseInt(blob.size || 0)) + '</td>';
                                html += '<td style="padding: 10px;">' + escapeHtml(blob.content_type || 'unknown') + '</td>';
                                html += '<td style="padding: 10px; text-align: center;">';
                                html += '<button onclick="viewBlob(\'' + escapeHtml(blob.name) + '\')" style="padding: 5px 10px; font-size: 0.85em;">üëÅÔ∏è View</button>';
                                html += '</td>';
                                html += '</tr>';
                            });
                            
                            html += '</tbody></table>';
                            html += '<p style="margin-top: 10px; color: #6c757d; font-size: 0.85em;">Found ' + data.blob_count + ' blob(s)</p>';
                        }
                        
                        resultDiv.innerHTML = html;
                    } else {
                        let html = '<div style="padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">';
                        html += '<p style="color: #721c24;"><strong>‚úó ' + escapeHtml(data.message) + '</strong></p>';
                        if (data.hint) {
                            html += '<p style="color: #721c24; font-size: 0.9em; margin-top: 10px;">üí° ' + escapeHtml(data.hint) + '</p>';
                        }
                        html += '</div>';
                        resultDiv.innerHTML = html;
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = 'üìÇ List Blob Contents';
                    resultDiv.innerHTML = '<p style="color: #dc3545;"><strong>Error:</strong> ' + escapeHtml(error.message) + '</p>';
                });
        }
        
        function viewBlob(blobName) {
            const viewerDiv = document.getElementById('blobContentViewer');
            const contentPre = document.getElementById('blobContentPre');
            
            viewerDiv.style.display = 'block';
            contentPre.textContent = 'Loading ' + blobName + '...';
            
            fetch('/storage/download/' + encodeURIComponent(blobName))
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        contentPre.innerHTML = '<span style="color: #6c757d;">// File: ' + escapeHtml(data.blob_name) + 
                            ' (' + formatBytes(data.size) + ')</span>\n' +
                            '<span style="color: #fd7e14;">// ' + escapeHtml(data.security_note) + '</span>\n\n' +
                            escapeHtml(data.content);
                    } else {
                        contentPre.textContent = 'Error: ' + data.message;
                    }
                })
                .catch(error => {
                    contentPre.textContent = 'Error loading blob: ' + error.message;
                });
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // =====================================================
        // Company Secure Data Entry Functions
        // =====================================================
        
        function checkCompanyDataAccess() {
            // Check if SKR was successful and show/hide company data section
            fetch('/company/info')
                .then(response => response.json())
                .then(data => {
                    const section = document.getElementById('companyDataSection');
                    const companyNameEl = document.getElementById('companyName');
                    
                    if (data.key_released && data.company) {
                        section.style.display = 'block';
                        companyNameEl.textContent = 'Company: ' + data.company.toUpperCase();
                    } else {
                        section.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.log('Company info check failed:', error);
                });
        }
        
        let csvPopulated = false;
        
        function autoPopulateFromCsv() {
            if (csvPopulated) return; // Only run once
            csvPopulated = true;
            
            const btn = document.getElementById('populateDbBtn');
            const resultDiv = document.getElementById('populateResult');
            
            btn.disabled = true;
            btn.innerHTML = '&#128203; Auto-importing CSV...';
            btn.style.opacity = '0.6';
            resultDiv.innerHTML = '<p style="color: #6610f2;"><em>Automatically reading CSV file from inside TEE, encrypting records...</em></p>';
            
            fetch('/company/populate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                // Keep button disabled after auto-import
                btn.innerHTML = '&#128203; CSV Imported';
                btn.style.background = '#6c757d';
                
                if (data.status === 'success') {
                    let html = '<div style="padding: 15px; background: #e2d9f3; border-radius: 8px; border-left: 4px solid #6610f2;">';
                    html += '<p style="color: #4a0e78;"><strong>&#10004; ' + escapeHtml(data.message) + '</strong></p>';
                    html += '<p style="color: #4a0e78; margin-top: 10px;">Source: <strong>' + escapeHtml(data.source_file) + '</strong></p>';
                    html += '<p style="color: #4a0e78;">Records added: <strong>' + data.records_added + '</strong></p>';
                    html += '<p style="color: #4a0e78;">Total records in consolidated file: <strong>' + data.total_records + '</strong></p>';
                    html += '<p style="color: #4a0e78;">Destination: <strong>' + escapeHtml(data.destination) + '</strong></p>';
                    html += '<p style="color: #4a0e78; font-size: 0.9em; margin-top: 10px;">&#128274; ' + escapeHtml(data.note) + '</p>';
                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    let html = '<div style="padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">';
                    html += '<p style="color: #721c24;"><strong>&#10006; ' + escapeHtml(data.message) + '</strong></p>';
                    html += '</div>';
                    resultDiv.innerHTML = html;
                }
            })
            .catch(error => {
                btn.innerHTML = '&#128203; Import Failed';
                btn.style.background = '#dc3545';
                resultDiv.innerHTML = '<p style="color: #dc3545;"><strong>Error:</strong> ' + escapeHtml(error.message) + '</p>';
            });
        }
        
        function populateFromCsv() {
            // Manual trigger - just call auto-populate
            autoPopulateFromCsv();
        }
        
        function saveCompanyData() {
            const nameField = document.getElementById('dataFieldName').value;
            const phoneField = document.getElementById('dataFieldPhone').value;
            const resultDiv = document.getElementById('saveDataResult');
            const btn = document.getElementById('saveDataBtn');
            
            if (!nameField && !phoneField) {
                resultDiv.innerHTML = '<p style="color: #dc3545;"><strong>Error:</strong> Please enter at least a name or phone number.</p>';
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '&#128190; Encrypting & Saving...';
            resultDiv.innerHTML = '<p style="color: #0078d4;"><em>Encrypting data with company key...</em></p>';
            
            fetch('/company/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: nameField,
                    phone: phoneField
                })
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '&#128190; Save Encrypted Data';
                
                if (data.status === 'success') {
                    let html = '<div style="padding: 15px; background: #d1e7dd; border-radius: 8px; border-left: 4px solid #198754;">';
                    html += '<p style="color: #0f5132;"><strong>&#10004; ' + escapeHtml(data.message) + '</strong></p>';
                    html += '<p style="color: #0f5132; margin-top: 10px;">Company: <strong>' + escapeHtml(data.company) + '</strong></p>';
                    html += '<p style="color: #0f5132;">Total records: <strong>' + data.record_count + '</strong></p>';
                    html += '<p style="color: #0f5132; font-size: 0.9em; margin-top: 10px;">&#128274; ' + escapeHtml(data.note) + '</p>';
                    html += '</div>';
                    resultDiv.innerHTML = html;
                    
                    // Clear the input fields
                    document.getElementById('dataFieldName').value = '';
                    document.getElementById('dataFieldPhone').value = '';
                } else {
                    let html = '<div style="padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">';
                    html += '<p style="color: #721c24;"><strong>&#10006; ' + escapeHtml(data.message) + '</strong></p>';
                    html += '</div>';
                    resultDiv.innerHTML = html;
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = '&#128190; Save Encrypted Data';
                resultDiv.innerHTML = '<p style="color: #dc3545;"><strong>Error:</strong> ' + escapeHtml(error.message) + '</p>';
            });
        }
        
        // Global storage for company records (for decrypt toggle)
        var storedCompanyRecords = [];
        var storedCompanyInfo = {};
        var isShowingDecrypted = false;
        
        function listCompanyData() {
            const btn = document.getElementById('listDataBtn');
            const viewerDiv = document.getElementById('companyDataViewer');
            const contentDiv = document.getElementById('companyDataContent');
            
            btn.disabled = true;
            btn.innerHTML = '&#128196; Loading...';
            viewerDiv.style.display = 'block';
            contentDiv.innerHTML = '<p style="color: #0078d4;"><em>Loading encrypted company data...</em></p>';
            
            fetch('/company/list')
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = '&#128196; List Saved Data';
                    
                    if (data.status === 'success') {
                        // Store records for decrypt toggle
                        storedCompanyRecords = data.records || [];
                        storedCompanyInfo = {
                            company: data.company,
                            blob_name: data.blob_name,
                            full_blob_url: data.full_blob_url,
                            record_count: data.record_count,
                            total_records_in_file: data.total_records_in_file,
                            note: data.note
                        };
                        
                        // Show encrypted view by default
                        renderCompanyDataTable(false);
                    } else {
                        contentDiv.innerHTML = '<p style="color: #dc3545;"><strong>Error:</strong> ' + escapeHtml(data.message) + '</p>';
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '&#128196; List Saved Data';
                    contentDiv.innerHTML = '<p style="color: #dc3545;"><strong>Error:</strong> ' + escapeHtml(error.message) + '</p>';
                });
        }
        
        function renderCompanyDataTable(showDecrypted) {
            const contentDiv = document.getElementById('companyDataContent');
            isShowingDecrypted = showDecrypted;
            
            // Header with full blob URL
            let html = '<div style="margin-bottom: 15px; padding: 12px; background: #e2e3e5; border-radius: 6px;">';
            html += '<div style="margin-bottom: 8px;"><strong>Company:</strong> ' + escapeHtml(storedCompanyInfo.company || '') + '</div>';
            html += '<div style="margin-bottom: 8px;"><strong>Storage URL:</strong></div>';
            html += '<div style="background: #fff; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 0.85em; word-break: break-all; margin-bottom: 8px;">';
            html += '<a href="' + escapeHtml(storedCompanyInfo.full_blob_url || '') + '" target="_blank" style="color: #0078d4;">' + escapeHtml(storedCompanyInfo.full_blob_url || storedCompanyInfo.blob_name || '') + '</a>';
            html += '</div>';
            html += '<div><strong>Records:</strong> ' + (storedCompanyInfo.record_count || 0) + ' of ' + (storedCompanyInfo.total_records_in_file || 0) + ' total';
            if (showDecrypted) {
                html += ' | <span style="color: #6f42c1; font-weight: bold;">&#128275; DECRYPTED VIEW</span>';
            }
            html += '</div></div>';
            
            if (storedCompanyRecords && storedCompanyRecords.length > 0) {
                // Scrollable table container
                html += '<div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px;">';
                html += '<table id="companyRecordsTable" style="width: 100%; border-collapse: collapse; background: white;">';
                html += '<thead style="position: sticky; top: 0; z-index: 1;"><tr style="background: ' + (showDecrypted ? '#6f42c1' : '#495057') + '; color: white;">';
                html += '<th style="padding: 10px; text-align: left;">ID</th>';
                html += '<th style="padding: 10px; text-align: left;">Timestamp</th>';
                html += '<th style="padding: 10px; text-align: left;">Name' + (showDecrypted ? '' : ' (Encrypted)') + '</th>';
                html += '<th style="padding: 10px; text-align: left;">Phone' + (showDecrypted ? '' : ' (Encrypted)') + '</th>';
                html += '</tr></thead><tbody>';
                
                // Get current company to highlight own records
                var currentCompany = storedCompanyInfo.company ? storedCompanyInfo.company.toLowerCase() : '';
                
                storedCompanyRecords.forEach(function(record, index) {
                    var nameDisplay = '';
                    var phoneDisplay = '';
                    var unableToDecrypt = false;
                    var recordCompany = record.company || 'unknown';
                    var isOwnRecord = recordCompany.toLowerCase() === currentCompany;
                    
                    if (showDecrypted) {
                        // Show decrypted values (stored during decrypt operation)
                        var nameVal = record.name_decrypted || '';
                        var phoneVal = record.phone_decrypted || '';
                        
                        // Check if this record couldn't be decrypted
                        var nameEncrypted = (nameVal === '(encrypted - no key available)');
                        var phoneEncrypted = (phoneVal === '(encrypted - no key available)');
                        
                        if (nameEncrypted || phoneEncrypted) {
                            // At least one field couldn't be decrypted - show as single row
                            unableToDecrypt = true;
                        } else {
                            nameDisplay = nameVal ? escapeHtml(nameVal) : '<em style="color:#999;">empty</em>';
                            phoneDisplay = phoneVal ? escapeHtml(phoneVal) : '<em style="color:#999;">empty</em>';
                        }
                    } else {
                        // Show encrypted (truncated)
                        nameDisplay = '<code style="font-size: 0.75em; word-break: break-all;">' + truncateText(record.name_encrypted, 40) + '</code>';
                        phoneDisplay = '<code style="font-size: 0.75em; word-break: break-all;">' + truncateText(record.phone_encrypted, 40) + '</code>';
                    }
                    
                    if (unableToDecrypt) {
                        // Show single row spanning name and phone columns - other company's data
                        html += '<tr style="border-bottom: 1px solid #dee2e6; background: #f8d7da;">';
                        html += '<td style="padding: 10px; font-weight: bold; color: #495057;">' + (record.line_number || (index + 1)) + '</td>';
                        html += '<td style="padding: 10px; font-size: 0.85em; color: #6c757d;">' + escapeHtml(record.timestamp || 'N/A') + '</td>';
                        html += '<td colspan="2" style="padding: 10px; text-align: center;"><em style="color: #dc3545; font-weight: bold;">&#128274; Unable to Decrypt Contents</em></td>';
                        html += '</tr>';
                    } else {
                        // Show normal row - own company's data
                        var rowBg = showDecrypted ? (isOwnRecord ? '#f8f5ff' : '#f8d7da') : (isOwnRecord ? '#d4edda' : 'white');
                        html += '<tr style="border-bottom: 1px solid #dee2e6; background: ' + rowBg + ';">';
                        html += '<td style="padding: 10px; font-weight: bold; color: #495057;">' + (record.line_number || (index + 1)) + '</td>';
                        html += '<td style="padding: 10px; font-size: 0.85em;">' + escapeHtml(record.timestamp || 'N/A') + '</td>';
                        html += '<td style="padding: 10px;">' + nameDisplay + '</td>';
                        html += '<td style="padding: 10px;">' + phoneDisplay + '</td>';
                        html += '</tr>';
                    }
                });
                
                html += '</tbody></table>';
                html += '</div>'; // Close scrollable container
                
                if (showDecrypted) {
                    html += '<p style="margin-top: 15px; padding: 10px; background: #e2d9f3; border-radius: 6px; color: #6f42c1; font-size: 0.9em;">';
                    html += '&#128275; <strong>Decrypted:</strong> Plaintext values shown. Release button to return to encrypted view.';
                    html += '</p>';
                } else {
                    html += '<p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; color: #856404; font-size: 0.9em;">';
                    html += '&#128274; <strong>Note:</strong> ' + escapeHtml(storedCompanyInfo.note || 'Data is encrypted with company-specific key.');
                    html += '</p>';
                }
            } else {
                html += '<p style="color: #6c757d;"><em>No records found.</em></p>';
            }
            
            contentDiv.innerHTML = html;
        }
        
        // Track whether we're currently showing decrypted view
        var isDecrypted = false;
        
        function toggleDecryptView() {
            if (storedCompanyRecords.length === 0) return;
            
            if (isDecrypted) {
                // Currently decrypted, switch to encrypted view
                showEncryptedView();
            } else {
                // Currently encrypted, switch to decrypted view
                showDecryptedView();
            }
        }
        
        function showDecryptedView() {
            if (storedCompanyRecords.length === 0) return;
            
            const btn = document.getElementById('decryptToggleBtn');
            btn.disabled = true;
            btn.innerHTML = '&#128275; Decrypting...';
            btn.style.background = '#5a32a3';
            
            // Decrypt all records
            var decryptPromises = [];
            
            storedCompanyRecords.forEach(function(record, index) {
                if (record.name_encrypted) {
                    decryptPromises.push(
                        decryptField(record.name_encrypted).then(function(plaintext) {
                            storedCompanyRecords[index].name_decrypted = plaintext;
                        }).catch(function() {
                            storedCompanyRecords[index].name_decrypted = '(encrypted - no key available)';
                        })
                    );
                } else {
                    storedCompanyRecords[index].name_decrypted = '';
                }
                if (record.phone_encrypted) {
                    decryptPromises.push(
                        decryptField(record.phone_encrypted).then(function(plaintext) {
                            storedCompanyRecords[index].phone_decrypted = plaintext;
                        }).catch(function() {
                            storedCompanyRecords[index].phone_decrypted = '(encrypted - no key available)';
                        })
                    );
                } else {
                    storedCompanyRecords[index].phone_decrypted = '';
                }
            });
            
            Promise.all(decryptPromises).then(function() {
                isDecrypted = true;
                btn.disabled = false;
                btn.innerHTML = '&#128274; Press to Encrypt';
                btn.style.background = '#28a745';
                renderCompanyDataTable(true);
            });
        }
        
        function showEncryptedView() {
            const btn = document.getElementById('decryptToggleBtn');
            isDecrypted = false;
            btn.innerHTML = '&#128275; Press to Decrypt';
            btn.style.background = '#6f42c1';
            
            if (storedCompanyRecords.length > 0) {
                renderCompanyDataTable(false);
            }
        }
        
        function decryptField(ciphertext) {
            return fetch('/decrypt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ciphertext: ciphertext })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    return data.plaintext;
                } else {
                    throw new Error(data.message);
                }
            });
        }
        
        function truncateText(text, maxLen) {
            if (!text) return 'null';
            if (text.length <= maxLen) return escapeHtml(text);
            return escapeHtml(text.substring(0, maxLen)) + '...';
        }
        
        // Cross-company key access attempt
        var otherCompanyConfig = null;
        
        function attemptOtherCompanyKey() {
            const btn = document.getElementById('attemptOtherKeyBtn');
            const resultDiv = document.getElementById('crossCompanyResult');
            
            btn.disabled = true;
            btn.innerHTML = '&#128683; Attempting Access...';
            
            resultDiv.innerHTML = '<div style="padding: 15px; background: #e2e3e5; border-radius: 8px;">' +
                '<p style="color: #495057;"><em>Attempting to access ' + 
                (otherCompanyConfig ? otherCompanyConfig.name : 'other company') + 
                '\'s key via SKR...</em></p></div>';
            
            fetch('/skr/release-other', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '&#128683; Attempt to Access Other Company\'s Key';
                
                if (data.status === 'access_denied') {
                    // This is the EXPECTED behavior - access should be denied
                    resultDiv.innerHTML = 
                        '<div style="padding: 20px; background: #d4edda; border-radius: 8px; border: 2px solid #28a745;">' +
                            '<h4 style="color: #155724; margin-bottom: 15px;">&#9989; Access Correctly Denied</h4>' +
                            '<div style="background: #c3e6cb; padding: 15px; border-radius: 5px; margin-bottom: 15px;">' +
                                '<p style="color: #155724; margin: 5px 0;"><strong>Our Company:</strong> ' + escapeHtml(data.our_company || 'Unknown') + '</p>' +
                                '<p style="color: #155724; margin: 5px 0;"><strong>Attempted Key:</strong> ' + escapeHtml(data.attempted_key || 'Unknown') + '</p>' +
                                '<p style="color: #155724; margin: 5px 0;"><strong>Target Key Vault:</strong> ' + escapeHtml(data.attempted_akv || 'Unknown') + '</p>' +
                            '</div>' +
                            '<p style="color: #155724;"><strong>This proves:</strong> Even though we are running in a trusted confidential container with TEE protection, we cannot access another company\'s cryptographic keys. The Azure Key Vault correctly rejected our managed identity.</p>' +
                            '<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 12px; word-break: break-all;">' +
                                '<strong>Error:</strong> ' + escapeHtml(data.error || 'Access denied') +
                            '</div>' +
                        '</div>';
                } else if (data.status === 'unexpected_success') {
                    // This should NEVER happen - would indicate a security issue
                    resultDiv.innerHTML = 
                        '<div style="padding: 20px; background: #f8d7da; border-radius: 8px; border: 2px solid #dc3545;">' +
                            '<h4 style="color: #721c24; margin-bottom: 15px;">&#9888; SECURITY ALERT - Unexpected Success!</h4>' +
                            '<p style="color: #721c24;"><strong>Warning:</strong> We were able to access another company\'s key. This indicates a misconfiguration in Key Vault access policies!</p>' +
                        '</div>';
                } else {
                    resultDiv.innerHTML = 
                        '<div style="padding: 20px; background: #f8d7da; border-radius: 8px; border: 2px solid #dc3545;">' +
                            '<h4 style="color: #721c24; margin-bottom: 15px;">&#10060; Error</h4>' +
                            '<p style="color: #721c24;">' + escapeHtml(data.message || 'Unknown error occurred') + '</p>' +
                        '</div>';
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = '&#128683; Attempt to Access Other Company\'s Key';
                resultDiv.innerHTML = 
                    '<div style="padding: 20px; background: #f8d7da; border-radius: 8px; border: 2px solid #dc3545;">' +
                        '<h4 style="color: #721c24; margin-bottom: 15px;">&#10060; Request Failed</h4>' +
                        '<p style="color: #721c24;">' + escapeHtml(error.message || 'Failed to contact server') + '</p>' +
                    '</div>';
            });
        }
        
        // Global flag for container type
        var isConfidentialContainer = true; // Default, updated on page load
        var partnerConfigs = null; // For Woodgrove Bank partner analysis
        
        function initializePageConfig() {
            // Fetch SKR config to get company name and container type
            fetch('/skr/config')
                .then(response => response.json())
                .then(data => {
                    // Update company name in encryption section
                    if (data.company_name) {
                        document.getElementById('encryptionCompanyName').textContent = data.company_name;
                    }
                    
                    // Store container type for later use
                    isConfidentialContainer = data.is_confidential;
                    
                    // Check if this is Woodgrove Bank and show partner analysis section
                    const isWoodgrove = data.is_woodgrove || (data.key_name && data.key_name.toLowerCase().includes('woodgrove'));
                    if (isWoodgrove && data.partner_configs) {
                        const partnerAnalysisSection = document.getElementById('partnerAnalysisSection');
                        if (partnerAnalysisSection) {
                            partnerAnalysisSection.style.display = 'block';
                            partnerConfigs = data.partner_configs;
                        }
                    }
                    
                    // Update cross-company section (for Contoso/Fabrikam only, not Woodgrove)
                    const crossCompanySection = document.getElementById('crossCompanySection');
                    const crossCompanyInfo = document.getElementById('crossCompanyInfo');
                    
                    // Show for confidential containers that have other_company config (Contoso or Fabrikam), but NOT for Woodgrove
                    if (data.other_company && data.other_company.name && !isWoodgrove) {
                        // Show cross-company section for confidential containers
                        crossCompanySection.style.display = 'block';
                        otherCompanyConfig = data.other_company;
                        
                        crossCompanyInfo.innerHTML = 
                            '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">' +
                                '<div style="padding: 15px; background: #d4edda; border-radius: 8px;">' +
                                    '<h5 style="color: #155724; margin-bottom: 10px;">&#127919; Our Company</h5>' +
                                    '<p style="color: #155724; margin: 5px 0;"><strong>Name:</strong> ' + escapeHtml(data.company_name) + '</p>' +
                                    '<p style="color: #155724; margin: 5px 0;"><strong>Key:</strong> ' + escapeHtml(data.key_name) + '</p>' +
                                    '<p style="color: #155724; margin: 5px 0; font-size: 11px;"><strong>Key Vault:</strong> ' + escapeHtml(data.akv_endpoint) + '</p>' +
                                '</div>' +
                                '<div style="padding: 15px; background: #f8d7da; border-radius: 8px;">' +
                                    '<h5 style="color: #721c24; margin-bottom: 10px;">&#128683; Other Company</h5>' +
                                    '<p style="color: #721c24; margin: 5px 0;"><strong>Name:</strong> ' + escapeHtml(data.other_company.name) + '</p>' +
                                    '<p style="color: #721c24; margin: 5px 0;"><strong>Key:</strong> ' + escapeHtml(data.other_company.key_name) + '</p>' +
                                    '<p style="color: #721c24; margin: 5px 0; font-size: 11px;"><strong>Key Vault:</strong> ' + escapeHtml(data.other_company.akv_endpoint) + '</p>' +
                                '</div>' +
                            '</div>';
                    } else {
                        // Hide for non-confidential containers
                        crossCompanySection.style.display = 'none';
                    }
                    
                    console.log('Container config:', {
                        company: data.company_name,
                        isConfidential: data.is_confidential,
                        otherCompany: data.other_company,
                        isWoodgrove: data.is_woodgrove,
                        partnerConfigs: data.partner_configs
                    });
                })
                .catch(error => {
                    console.log('Could not load SKR config:', error);
                });
        }
        
        // Partner Analysis Functions (Woodgrove Bank only)
        async function startPartnerAnalysis() {
            const btn = document.getElementById('startPartnerAnalysisBtn');
            const resultDiv = document.getElementById('partnerAnalysisResult');
            const summaryDiv = document.getElementById('demographicsSummary');
            
            if (!partnerConfigs) {
                resultDiv.innerHTML = '<p style="color: #dc3545;">Partner configurations not available.</p>';
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '&#128202; Analyzing Partner Data<span class="loading"></span>';
            resultDiv.innerHTML = '<p>Starting partner demographic analysis...</p>';
            
            let contosoData = [];
            let fabrikamData = [];
            let contosoKey = null;
            let fabrikamKey = null;
            
            // Step 1: Release Contoso key
            updateKeyStatus('contoso', 'loading', 'Requesting key release...');
            try {
                const contosoResponse = await fetch('/skr/release-partner', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partner: 'contoso' })
                });
                const contosoResult = await contosoResponse.json();
                
                if (contosoResult.status === 'success') {
                    contosoKey = contosoResult.key;
                    updateKeyStatus('contoso', 'success', 'Key released successfully');
                } else {
                    updateKeyStatus('contoso', 'error', contosoResult.message || 'Failed to release key');
                }
            } catch (e) {
                updateKeyStatus('contoso', 'error', 'Error: ' + e.message);
            }
            
            // Step 2: Release Fabrikam key
            updateKeyStatus('fabrikam', 'loading', 'Requesting key release...');
            try {
                const fabrikamResponse = await fetch('/skr/release-partner', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partner: 'fabrikam' })
                });
                const fabrikamResult = await fabrikamResponse.json();
                
                if (fabrikamResult.status === 'success') {
                    fabrikamKey = fabrikamResult.key;
                    updateKeyStatus('fabrikam', 'success', 'Key released successfully');
                } else {
                    updateKeyStatus('fabrikam', 'error', fabrikamResult.message || 'Failed to release key');
                }
            } catch (e) {
                updateKeyStatus('fabrikam', 'error', 'Error: ' + e.message);
            }
            
            // Step 3: Stream decryption progress using SSE
            resultDiv.innerHTML = '<p>Connecting to analysis stream...</p>';
            
            // Show progress section
            const progressSection = document.getElementById('progressSection');
            progressSection.style.display = 'block';
            
            const eventSource = new EventSource('/partner/analyze-stream');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'status') {
                    document.getElementById('progressStatus').textContent = data.message;
                    if (data.phase === 'fetch') {
                        resultDiv.innerHTML = '<p>üì• ' + escapeHtml(data.message) + '</p>';
                    } else if (data.phase === 'decrypt') {
                        resultDiv.innerHTML = '<p>üîê ' + escapeHtml(data.message) + '</p>';
                    } else if (data.phase === 'analyze') {
                        resultDiv.innerHTML = '<p>üìä ' + escapeHtml(data.message) + '</p>';
                    }
                }
                else if (data.type === 'fetch') {
                    resultDiv.innerHTML += '<p style="color: #495057; font-size: 13px;">‚úì Found ' + data.count + ' encrypted records from ' + escapeHtml(data.partner) + '</p>';
                }
                else if (data.type === 'progress') {
                    document.getElementById('progressBar').style.width = data.percent + '%';
                    document.getElementById('progressPercent').textContent = data.percent + '%';
                    document.getElementById('progressDecrypted').textContent = data.decrypted + ' / ' + data.total + ' records';
                    document.getElementById('progressTime').textContent = 'Elapsed: ' + data.elapsed + 's | Remaining: ~' + data.remaining + 's';
                    document.getElementById('progressPartner').textContent = 'üîê Decrypting ' + escapeHtml(data.current_partner) + ' records...';
                    document.getElementById('progressStatus').textContent = 'Decrypting records...';
                }
                else if (data.type === 'complete') {
                    eventSource.close();
                    
                    // Hide progress section
                    progressSection.style.display = 'none';
                    
                    // Show demographics summary
                    summaryDiv.style.display = 'block';
                    
                    // Staff counts
                    document.getElementById('statContosoRecords').textContent = data.contoso_count || 0;
                    document.getElementById('statFabrikamRecords').textContent = data.fabrikam_count || 0;
                    document.getElementById('statTotalRecords').textContent = data.total_count || 0;
                    
                    // Average salaries
                    if (data.avg_salaries) {
                        document.getElementById('avgSalaryContoso').textContent = '$' + (data.avg_salaries.Contoso || 0).toLocaleString();
                        document.getElementById('avgSalaryFabrikam').textContent = '$' + (data.avg_salaries.Fabrikam || 0).toLocaleString();
                        document.getElementById('avgSalaryCombined').textContent = '$' + (data.avg_salaries.Combined || 0).toLocaleString();
                    }
                    
                    // Generation breakdown
                    if (data.generations && data.generations.length > 0) {
                        let genHtml = '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                        const genColors = {
                            'Gen Alpha': '#ff6b6b',
                            'Gen Z': '#4ecdc4',
                            'Millennials': '#45b7d1',
                            'Gen X': '#96ceb4',
                            'Baby Boomers': '#ffeaa7',
                            'Silent Generation': '#dfe6e9'
                        };
                        data.generations.forEach(g => {
                            const color = genColors[g.generation] || '#dee2e6';
                            genHtml += '<div style="padding: 10px 15px; background: ' + color + '; border-radius: 8px; text-align: center;">';
                            genHtml += '<div style="font-size: 20px; font-weight: bold;">' + g.count + '</div>';
                            genHtml += '<div style="font-size: 11px;">' + escapeHtml(g.generation) + '</div>';
                            genHtml += '</div>';
                        });
                        genHtml += '</div>';
                        document.getElementById('generationBreakdown').innerHTML = genHtml;
                    }
                    
                    // Eye colors
                    if (data.eye_colors) {
                        const most = data.eye_colors.most_common;
                        const least = data.eye_colors.least_common;
                        document.getElementById('eyeColorMost').textContent = most.color + ' (' + most.count + ')';
                        document.getElementById('eyeColorLeast').textContent = least.color + ' (' + least.count + ')';
                    }
                    
                    // Favorite colors
                    if (data.top_3_favorite_colors && data.top_3_favorite_colors.length > 0) {
                        let favHtml = '';
                        const medals = ['ü•á', 'ü•à', 'ü•â'];
                        data.top_3_favorite_colors.forEach((fc, idx) => {
                            favHtml += '<div style="padding: 12px 20px; background: #f8f9fa; border-radius: 8px; text-align: center; border: 2px solid #dee2e6;">';
                            favHtml += '<div style="font-size: 20px;">' + medals[idx] + '</div>';
                            favHtml += '<div style="font-size: 16px; font-weight: bold; color: #495057;">' + escapeHtml(fc.color) + '</div>';
                            favHtml += '<div style="font-size: 12px; color: #6c757d;">' + fc.count + ' people</div>';
                            favHtml += '</div>';
                        });
                        document.getElementById('favoriteColors').innerHTML = favHtml;
                    }
                    
                    // Top 10 countries with cities
                    if (data.top_10_countries && data.top_10_countries.length > 0) {
                        let countryHtml = '<table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">';
                        countryHtml += '<thead><tr style="background: #1a472a; color: white;">';
                        countryHtml += '<th style="padding: 12px; text-align: left;">Rank</th>';
                        countryHtml += '<th style="padding: 12px; text-align: left;">Country</th>';
                        countryHtml += '<th style="padding: 12px; text-align: center;">Staff</th>';
                        countryHtml += '<th style="padding: 12px; text-align: left;">Top 3 Cities</th>';
                        countryHtml += '</tr></thead><tbody>';
                        
                        data.top_10_countries.forEach((c, idx) => {
                            const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
                            const citiesStr = c.top_cities.map(city => city.city + ' (' + city.count + ')').join(', ');
                            countryHtml += '<tr style="background: ' + bgColor + ';">';
                            countryHtml += '<td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">#' + (idx + 1) + '</td>';
                            countryHtml += '<td style="padding: 10px; border-bottom: 1px solid #dee2e6;">üåç ' + escapeHtml(c.country) + '</td>';
                            countryHtml += '<td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: center; font-weight: bold;">' + c.count + '</td>';
                            countryHtml += '<td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-size: 12px; color: #6c757d;">' + escapeHtml(citiesStr) + '</td>';
                            countryHtml += '</tr>';
                        });
                        
                        countryHtml += '</tbody></table>';
                        document.getElementById('countriesTable').innerHTML = countryHtml;
                    }
                    
                    // Show success message
                    let resultMessage = '<p style="color: #155724;"><strong>‚úì Partner analysis complete!</strong> Successfully decrypted and analyzed ' + data.total_count + ' records in ' + data.total_time + ' seconds.</p>';
                    
                    // Show any errors that occurred
                    if (data.errors && data.errors.length > 0) {
                        resultMessage += '<p style="color: #856404; font-size: 12px;"><strong>Notes:</strong><br>' + data.errors.map(e => '‚Ä¢ ' + escapeHtml(e)).join('<br>') + '</p>';
                    }
                    
                    resultDiv.innerHTML = resultMessage;
                    
                    // Reset button
                    btn.disabled = false;
                    btn.innerHTML = '&#128202; Start Partner Demographic Analysis';
                }
                else if (data.type === 'error') {
                    eventSource.close();
                    progressSection.style.display = 'none';
                    resultDiv.innerHTML = '<p style="color: #dc3545;"><strong>Analysis failed:</strong> ' + escapeHtml(data.message) + '</p>';
                    if (data.errors) {
                        resultDiv.innerHTML += '<p style="color: #856404; font-size: 12px;">' + data.errors.map(e => '‚Ä¢ ' + escapeHtml(e)).join('<br>') + '</p>';
                    }
                    btn.disabled = false;
                    btn.innerHTML = '&#128202; Start Partner Demographic Analysis';
                }
            };
            
            eventSource.onerror = function(event) {
                eventSource.close();
                progressSection.style.display = 'none';
                resultDiv.innerHTML = '<p style="color: #dc3545;"><strong>Connection error:</strong> Lost connection to server.</p>';
                btn.disabled = false;
                btn.innerHTML = '&#128202; Start Partner Demographic Analysis';
            };
        }
        
        function updateKeyStatus(company, status, message) {
            const iconEl = document.getElementById(company + 'StatusIcon');
            const textEl = document.getElementById(company + 'StatusText');
            const containerEl = document.getElementById(company + 'KeyStatus');
            
            if (status === 'loading') {
                iconEl.textContent = '‚è≥';
                containerEl.style.borderColor = '#ffc107';
                containerEl.style.background = '#fff3cd';
            } else if (status === 'success') {
                iconEl.textContent = '‚úÖ';
                containerEl.style.borderColor = '#28a745';
                containerEl.style.background = '#d4edda';
            } else if (status === 'error') {
                iconEl.textContent = '‚ùå';
                containerEl.style.borderColor = '#dc3545';
                containerEl.style.background = '#f8d7da';
            }
            
            textEl.textContent = message;
        }
        
        // Page timer - tracks time since last refresh
        var pageLoadTime = Date.now();
        
        function updatePageTimer() {
            var elapsed = Math.floor((Date.now() - pageLoadTime) / 1000);
            var hours = Math.floor(elapsed / 3600);
            var minutes = Math.floor((elapsed % 3600) / 60);
            var seconds = elapsed % 60;
            
            var timerText;
            if (hours > 0) {
                timerText = String(hours).padStart(2, '0') + ':' + 
                           String(minutes).padStart(2, '0') + ':' + 
                           String(seconds).padStart(2, '0');
            } else {
                timerText = String(minutes).padStart(2, '0') + ':' + 
                           String(seconds).padStart(2, '0');
            }
            
            document.getElementById('pageTimer').textContent = timerText;
        }
        
        // Update timer every second
        setInterval(updatePageTimer, 1000);
        updatePageTimer(); // Initial call
        
        // =====================================================
        // Snooper Auto-Refresh Functionality
        // =====================================================
        
        var snooperRefreshInterval = null;
        var SNOOPER_REFRESH_SECONDS = 5;
        var consolidatedBlobName = 'consolidated-records.json'; // Default, will be updated from /storage/config
        
        function initializeSnooperMode() {
            // Show snooper-specific elements
            document.getElementById('snooperExplainer').style.display = 'block';
            document.getElementById('autoRefreshIndicator').style.display = 'block';
            document.getElementById('snooperRecordsView').style.display = 'block';
            document.getElementById('refreshInterval').textContent = SNOOPER_REFRESH_SECONDS;
            
            // Update the blob name in the header
            document.getElementById('snooperBlobName').textContent = consolidatedBlobName;
            
            // Open the blob storage section by default for snooper
            document.getElementById('blobStorageSection').setAttribute('open', '');
            
            // Start auto-refresh
            refreshSnooperRecords();
            snooperRefreshInterval = setInterval(refreshSnooperRecords, SNOOPER_REFRESH_SECONDS * 1000);
            
            console.log('Snooper mode activated - auto-refreshing every ' + SNOOPER_REFRESH_SECONDS + ' seconds');
        }
        
        function refreshSnooperRecords() {
            // Update last refresh time
            var now = new Date();
            var timeStr = String(now.getHours()).padStart(2, '0') + ':' + 
                          String(now.getMinutes()).padStart(2, '0') + ':' + 
                          String(now.getSeconds()).padStart(2, '0');
            document.getElementById('lastRefreshTime').textContent = timeStr;
            
            // Fetch consolidated records using dynamic blob name
            fetch('/storage/download/' + encodeURIComponent(consolidatedBlobName))
                .then(response => response.json())
                .then(data => {
                    renderSnooperRecordsTable(data);
                })
                .catch(error => {
                    document.getElementById('snooperRecordsTable').innerHTML = 
                        '<p style="color: #ff6b6b;">Error fetching records: ' + escapeHtml(error.message) + '</p>';
                });
        }
        
        function renderSnooperRecordsTable(data) {
            var tableDiv = document.getElementById('snooperRecordsTable');
            
            if (data.status !== 'success') {
                tableDiv.innerHTML = '<p style="color: #ffc107;"><em>&#128269; No ' + escapeHtml(consolidatedBlobName) + ' found yet. Companies need to populate their data first.</em></p>';
                return;
            }
            
            var records;
            try {
                records = JSON.parse(data.content);
                if (!Array.isArray(records)) {
                    records = [records];
                }
            } catch (e) {
                tableDiv.innerHTML = '<p style="color: #ff6b6b;">Could not parse records: ' + escapeHtml(e.message) + '</p>';
                return;
            }
            
            if (records.length === 0) {
                tableDiv.innerHTML = '<p style="color: #ffc107;"><em>No records found in file.</em></p>';
                return;
            }
            
            var html = '<p style="color: #28a745; margin-bottom: 15px;">&#10004; Successfully intercepted <strong>' + records.length + '</strong> encrypted records!</p>';
            
            html += '<table style="width: 100%; border-collapse: collapse; color: #f8f8f2;">';
            html += '<thead><tr style="background: #343a40;">';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #dc3545;">#</th>';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #dc3545;">Name (Encrypted)</th>';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #dc3545;">Phone (Encrypted)</th>';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #dc3545;">Timestamp</th>';
            html += '</tr></thead><tbody>';
            
            records.forEach(function(record, index) {
                html += '<tr style="border-bottom: 1px solid #495057;">';
                html += '<td style="padding: 10px;">' + (index + 1) + '</td>';
                html += '<td style="padding: 10px; font-family: monospace; font-size: 0.75em; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + escapeHtml(record.name_encrypted || '') + '">';
                html += '<span style="color: #ff6b6b;">&#128274;</span> ' + truncateText(record.name_encrypted || 'null', 30);
                html += '</td>';
                html += '<td style="padding: 10px; font-family: monospace; font-size: 0.75em; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + escapeHtml(record.phone_encrypted || '') + '">';
                html += '<span style="color: #ff6b6b;">&#128274;</span> ' + truncateText(record.phone_encrypted || 'null', 30);
                html += '</td>';
                html += '<td style="padding: 10px; font-size: 0.8em; color: #adb5bd;">' + escapeHtml(record.timestamp || 'N/A') + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            html += '<div style="margin-top: 15px; padding: 10px; background: #dc3545; border-radius: 6px;">';
            html += '<p style="color: white; margin: 0; text-align: center;"><strong>&#128683; No access to keys to decrypt data</strong> - This snooper cannot access the SKR keys needed to reveal the plaintext!</p>';
            html += '</div>';
            
            tableDiv.innerHTML = html;
        }
        
        // Load storage config on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializePageConfig();
            loadStorageConfig();
            // Check company data access after a short delay (to allow SKR status to load)
            setTimeout(checkCompanyDataAccess, 1000);
            
            // Check if this is a snooper (non-confidential) container and activate snooper mode
            setTimeout(function() {
                if (!isConfidentialContainer) {
                    initializeSnooperMode();
                }
            }, 1500);
            
            // Auto-populate from CSV when "Protect Data" section is expanded
            const companyDataSection = document.getElementById('companyDataSection');
            if (companyDataSection) {
                companyDataSection.addEventListener('toggle', function() {
                    if (this.open) {
                        autoPopulateFromCsv();
                    }
                });
            }
        });
    </script>
</body>
</html>

